<!DOCTYPE html>
 <html lang="zh-CN">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
     <title>å¼ çŠçŠå¥³å£«ï¼Œç”Ÿæ—¥å¿«ä¹ï¼</title>

     <link rel="preload" href="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/pfsg.ttf" as="font" type="font/ttf" crossorigin>

     <style>
         /* --- Web Font Definition --- */
         @font-face {
             font-family: 'MyCustomLetterFont';
             src: url('https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/pfsg.ttf');
             font-weight: normal;
             font-style: normal;
             font-display: swap;
         }

         /* --- General Styles --- */
         *, *::before, *::after { box-sizing: border-box; }
         html { -webkit-tap-highlight-color: transparent; }
         body {
             font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", system-ui, sans-serif;
             line-height: 1.6; margin: 0;
             padding-bottom: 80px; /* Space for audio player */
             background-color: #f8f0f8; /* Fallback background */
             overflow-x: hidden; font-size: 16px; min-height: 100vh; position: relative; -webkit-overflow-scrolling: touch;
             /* Add padding for safe areas */
             padding-top: env(safe-area-inset-top, 0px);
             padding-left: env(safe-area-inset-left, 0px);
             padding-right: env(safe-area-inset-right, 0px);
             padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
         }
         body, div, p, h1, button, img, input { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

         /* --- Background Layers --- */
         #background-layer {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
             background-image: url("https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/background-placeholder.jpg");
             background-size: cover;
             background-position: center center; /* Center the background image */
         }
         #background-overlay {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
             background-color: rgba(255, 255, 255, 0.4); /* Lighter, more transparent */
             backdrop-filter: blur(12px); /* Increased blur */
             -webkit-backdrop-filter: blur(12px);
         }
         @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
             #background-overlay {
                 background-color: rgba(248, 240, 248, 0.85); /* More opaque fallback */
             }
         }

         /* --- Views (Overlay) --- */
         .overlay-view {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             display: none; /* Hidden initially */
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding: 20px;
             text-align: center;
             background-color: rgba(245, 245, 245, 0.2);
             backdrop-filter: blur(15px);
             -webkit-backdrop-filter: blur(15px);
         }
          @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
             .overlay-view {
                 background-color: rgba(0, 0, 0, 0.75);
             }
         }

         #birthday-view, #love-letter-view {
              padding: 15px; position: relative; z-index: 1; display: none;
         }
         #birthday-view {
             display: block; /* Show birthday view initially */
             background-color: transparent;
             cursor: url('https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/Aero_arrow.cur') 16 16, auto;
             min-height: 100vh;
         }
         #love-letter-view {
             background-color: rgba(255, 250, 240, 0.92);
             color: #5a463a; max-width: 95%; margin: 40px auto;
             box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
             border-radius: 16px;
             padding: 20px; padding-top: 60px; padding-bottom: 80px; position: relative; z-index: 10;
         }
         #love-letter-view::before { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 0; border-style: solid; border-width: 60px 0 0 calc(50vw - 15px); border-color: rgba(254, 202, 202, 0.8) transparent transparent rgba(254, 202, 202, 0.8); z-index: 1; border-top-left-radius: 16px; }
         #love-letter-view::after { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 0; border-style: solid; border-width: 0 0 60px calc(50vw - 15px); border-color: transparent rgba(254, 202, 202, 0.8) rgba(254, 202, 202, 0.8) transparent; z-index: 1; border-top-right-radius: 16px; }

         /* --- Birthday View Content Styles --- */
         #birthday-view .birthday-container { z-index: 10; display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: 30px; position: relative; padding: 0 30px;}
         #birthday-view #birthday-cake-link { display: flex; justify-content: center; width: 100%; text-decoration: none; cursor: inherit; position: relative; -webkit-tap-highlight-color: transparent; }
         #birthday-view #birthday-cake { display: block; max-width: 100%; max-height: 280px; height: auto; width: auto; object-fit: contain; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); transition: transform 0.2s ease-in-out; }
         #birthday-view #birthday-cake-link:hover #birthday-cake { transform: scale(1.05); }
         #birthday-message { font-size: 1.4em; font-weight: bold; color: #e83e8c; text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.9); margin-top: 0; padding: 0 10px; margin-bottom: 30px; position: relative; z-index: 10; text-align: center; }
         #birthday-view h1 { font-size: 1.8em; color: #6f42c1; text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.7); text-align: center; position: relative; z-index: 10; margin-bottom: 15px; overflow: hidden; }
         #birthday-view h1::after { content: 'âœ¨'; position: absolute; top: -5px; right: -10px; font-size: 0.8em; opacity: 0; animation: sparkle 2.5s infinite ease-in-out; animation-delay: 0.5s; z-index: 11; }
         @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0.5) rotate(0deg); } 25%, 75% { opacity: 0.8; transform: scale(1) rotate(15deg); } 50% { opacity: 0.5; transform: scale(0.8) rotate(-10deg); } }
         #birthday-view hr { position: relative; z-index: 10; margin-top: 30px; border: 0; height: 1px; background: #ccc; }
         #birthday-view .footer-text { text-align: center; color: #333; text-shadow: 0 0 5px rgba(255,255,255,0.8); position: relative; z-index: 10; padding-bottom: 20px; font-size: 0.9em; }

         /* --- Love Letter View Styles --- */
         #love-letter-view h1 {
             font-size: 1.6em; color: #d9534f; text-align: center; margin-bottom: 25px;
             font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", system-ui, sans-serif;
             position: relative; padding: 0 30px; z-index: 2;
             display: inline-block; margin-right: 10px; margin-bottom: 15px; vertical-align: middle;
         }
         #love-letter-view h1::before { content: 'ğŸ‚'; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); font-size: 0.9em; z-index: 3;}
         #love-letter-view h1::after { content: 'â¤ï¸'; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.9em; z-index: 3;}
         #love-letter-view p { font-family: 'MyCustomLetterFont', 'KaiTi', 'STKaiti', 'SimSun', serif; margin-bottom: 1.3em; text-indent: 2em; font-size: 1em; position: relative; z-index: 2; overflow-wrap: break-word; word-wrap: break-word; transition: font-family 0.3s ease; }
         #love-letter-view .signature { font-family: 'MyCustomLetterFont', 'KaiTi', 'STKaiti', 'SimSun', serif; text-align: right; margin-top: 30px; font-style: italic; line-height: 1.6; font-size: 0.95em; position: relative; z-index: 2; word-break: break-word; transition: font-family 0.3s ease; }
         #love-letter-view.love-letter-default-font p,
         #love-letter-view.love-letter-default-font .signature { font-family: 'KaiTi', 'STKaiti', 'SimSun', serif; }

         /* --- Buttons --- */
         .styled-button {
             display: inline-block; margin: 8px; padding: 10px 20px; border: none; border-radius: 8px;
             cursor: pointer; font-size: 1em; font-weight: 500;
             font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", system-ui, sans-serif;
             -webkit-tap-highlight-color: transparent;
             transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
             text-decoration: none; color: white; text-align: center; line-height: 1.4;
             box-shadow: 0 2px 5px rgba(0,0,0,0.15);
         }
         .styled-button:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
         .styled-button:active { transform: scale(0.97); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
         .styled-button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; }

         /* Specific Button Colors */
         #font-toggle-button, #back-from-game, #continue-game-button, #password-submit-button, #spin-button { background-color: #ff75ac; }
         #font-toggle-button:hover, #back-from-game:hover, #continue-game-button:hover, #password-submit-button:hover, #spin-button:hover { background-color: #ff5c9a; }
         #font-toggle-button:disabled:hover, #spin-button:disabled:hover { background-color: #cccccc; }

         #love-letter-view #font-toggle-button { display: inline-block; padding: 6px 12px; font-size: 0.85em; vertical-align: middle; margin-bottom: 15px; margin-top: 0; margin-left: 0; margin-right: 0; }

         .back-button, #back-from-slot-machine, #close-prize-dialog /* Updated ID */ { padding: 12px 25px; font-size: 1.1em; background-color: #6f42c1; }
         .back-button:hover, #back-from-slot-machine:hover, #close-prize-dialog:hover /* Updated ID */ { background-color: #5a349a; }

         #goto-game-button, #confirm-start-game, .show-slot-winnings-button { background-color: #ff9800; }
         #goto-game-button:hover, #confirm-start-game:hover, .show-slot-winnings-button:hover { background-color: #f57c00; }

         #redeem-early-button, #proceed-to-hongbao-game { background-color: #4CAF50; }
         #redeem-early-button:hover, #proceed-to-hongbao-game:hover { background-color: #45a049; }

         .love-letter-buttons { text-align: center; margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }

         .small-button { padding: 6px 12px; font-size: 0.9em; }

         /* --- Falling Items Styles --- */
         .falling-item { position: absolute; top: -60px; font-size: 22px; user-select: none; pointer-events: none; animation: fall linear forwards; opacity: 0.75; z-index: 5; will-change: transform, opacity; }
         @keyframes fall { 0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.75; } 100% { transform: translateY(calc(100vh + 100px)) rotate(calc(var(--random-rotate, 0) * 1deg)); opacity: 0; } }

         /* --- Pointer Trail Heart Styles --- */
         .pointer-heart { position: absolute; font-size: 18px; color: #ff4d6d; pointer-events: none; user-select: none; z-index: 9999; animation: fade-move-out-quick 0.6s ease-out forwards; text-shadow: 0 0 4px rgba(0, 0, 0, 0.2); }
         @keyframes fade-move-out-quick { 0% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -120%) scale(0.3); } }

         /* --- Slideshow Styles --- */
         #photo-slideshow-container { position: relative; z-index: 10; max-width: 500px; margin: 20px auto; padding: 15px; background-color: rgba(255, 255, 255, 0.8); border-radius: 16px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); border: none; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
         #slideshow-wrapper { position: relative; overflow: hidden; border-radius: 12px; aspect-ratio: 4 / 3; background-color: #eee; }
         #slideshow { display: flex; width: 100%; height: 100%; transition: transform 0.5s ease-in-out; }
         .slide { min-width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
         .slide img { display: block; width: 100%; height: 100%; object-fit: cover; }
         .slideshow-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.3); border: none; color: #fff; font-size: 1.5em; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 15; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; line-height: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); -webkit-tap-highlight-color: transparent; }
         .slideshow-nav:hover { background-color: rgba(0, 0, 0, 0.5); }
         .slideshow-nav.prev { left: 10px; }
         .slideshow-nav.next { right: 10px; }
         .dots-container { text-align: center; margin-top: 15px; position: relative; z-index: 15; }
         .dot { display: inline-block; width: 8px; height: 8px; background-color: rgba(0, 0, 0, 0.2); border-radius: 50%; margin: 0 5px; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s ease; }
         .dot.active { background-color: #ff75ac; transform: scale(1.3); }
         #slideshow-caption { text-align: center; margin-top: 15px; font-size: 0.95em; color: #555; padding: 8px; min-height: 1.5em; font-style: italic; background-color: rgba(255, 255, 255, 0.5); border-radius: 8px; }

         /* --- Custom Audio Player Styles --- */
         #audio-player-container {
             position: fixed; bottom: 10px; right: 10px; left: auto; transform: none; width: 85%; max-width: 320px; z-index: 10000;
             background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(10px) saturate(120%); -webkit-backdrop-filter: blur(10px) saturate(120%);
             border-radius: 16px; padding: 10px 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
             border: 1px solid rgba(255, 255, 255, 0.2); display: flex; align-items: center; gap: 10px; cursor: move; touch-action: none;
         }
         @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) { #audio-player-container { background-color: rgba(255, 222, 233, 0.9); } }
         #play-pause-button { background-color: #ff75ac; border: none; color: white; font-size: 1.3em; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; flex-shrink: 0; padding: 0; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.15); -webkit-tap-highlight-color: transparent; }
         #play-pause-button:hover { background-color: #ff5c9a; }
         #play-pause-button .play-icon::before { content: 'â–¶ï¸'; }
         #play-pause-button .pause-icon::before { content: 'â¸ï¸'; }
         .audio-controls-right { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
         #song-title { font-size: 0.8em; color: #555; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; font-weight: 500; }
         #seek-bar { width: 100%; height: 6px; cursor: pointer; appearance: none; background: rgba(255, 194, 209, 0.5); border-radius: 3px; outline: none; }
         #seek-bar::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: #ff75ac; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
         #seek-bar::-moz-range-thumb { width: 14px; height: 14px; background: #ff75ac; border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
         .time-display { display: flex; justify-content: space-between; font-size: 0.75em; color: #666; margin-top: 2px; padding: 0 2px; }
         #audio-element { display: none; }

         /* --- Cat Pendant Styles --- */
         #cat-pendant { position: fixed; top: 15px; left: 15px; width: 60px; height: 60px; z-index: 9998; cursor: move; overflow: visible; background-color: transparent; transition: transform 0.2s ease; -webkit-tap-highlight-color: transparent; touch-action: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
         #cat-pendant:hover { transform: scale(1.1); }
         #cat-pendant img { display: block; width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
         #cat-pendant.rolling { animation: cat-roll 0.7s linear; }
         @keyframes cat-roll { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
         #cat-dialog {
             position: absolute; top: 50%; left: 110%; transform: translateY(-50%); min-width: 180px; max-width: 220px; padding: 12px 18px; border-radius: 12px;
             background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px) saturate(110%); -webkit-backdrop-filter: blur(8px) saturate(110%);
             box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.25);
             color: #333; font-size: 0.9em; text-align: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0s linear 0.3s; z-index: 1; pointer-events: none;
         }
         #cat-dialog::after { content: ''; position: absolute; top: 50%; right: 100%; transform: translateY(-50%); width: 0; height: 0; border-style: solid; border-width: 8px 8px 8px 0; border-color: transparent rgba(255, 255, 255, 0.7) transparent transparent; }
         #cat-dialog.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease-out, visibility 0s linear 0s; }
         @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) { #cat-dialog { background-color: rgba(255, 192, 203, 0.9); } #cat-dialog::after { border-color: transparent rgba(255, 192, 203, 0.9) transparent transparent; } }

         /* --- Warning Message Styles --- */
         #love-warning-message {
             position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px 45px;
             background-color: rgba(255, 105, 135, 0.3); color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
             font-size: 1.6em; font-weight: bold; text-align: center; border-radius: 16px;
             box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2); z-index: 11000; display: none;
             backdrop-filter: blur(12px) saturate(130%); -webkit-backdrop-filter: blur(12px) saturate(130%);
             border: 1px solid rgba(255, 255, 255, 0.2); max-width: 90%;
         }
         @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) { #love-warning-message { background-color: rgba(229, 57, 53, 0.9); color: white; } }

         /* --- Shared Box Style for Modal Content --- */
         .modal-content-box {
             background-color: rgba(255, 255, 255, 0.85); padding: 25px 35px; border-radius: 16px;
             box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); color: #333; max-width: 90%;
             border: 1px solid rgba(255, 255, 255, 0.1); position: relative;
         }

         /* --- Game Start Warning Styles --- */
         #game-start-warning { z-index: 90; }
         #game-start-warning-box p { margin-bottom: 25px; font-size: 1.1em; line-height: 1.6; }

        /* --- Password Prompt Styles --- */
         #password-prompt-view { z-index: 95; }
         #password-prompt-box h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.3em; color: #e83e8c; }
         #password-input {
             padding: 12px; margin-bottom: 20px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; font-size: 1.1em;
             width: 120px; text-align: center; background-color: rgba(255, 255, 255, 0.7); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
             -moz-appearance: textfield; appearance: textfield;
         }
         #password-input:focus { outline: 2px solid #ffc2d1; outline-offset: 2px; border-color: rgba(0, 0, 0, 0.2); }
         #password-error-message { color: #d9534f; font-size: 0.95em; min-height: 1.3em; margin-top: 5px; }

         /* --- Game View Styles --- */
         #game-view {
             z-index: 100; padding-top: env(safe-area-inset-top, 20px); padding-bottom: env(safe-area-inset-bottom, 20px);
         }
         #game-info {
             padding: 12px 25px; margin-bottom: 20px; font-size: 1.1em; font-weight: 500;
             min-width: 280px; background-color: rgba(255, 255, 255, 0.9);
         }
         #game-info span { display: inline-block; margin: 0 8px; }
         #game-area {
             width: 100%; max-width: 600px; height: 65%; background-color: rgba(255, 255, 255, 0.15);
             border: 1px solid rgba(255, 255, 255, 0.3); position: relative; overflow: hidden;
             border-radius: 16px; margin-bottom: 20px; box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
         }
         .game-item {
             position: absolute; width: 50px; height: 70px; border-radius: 8px;
             cursor: pointer; top: -80px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;
             box-shadow: 0 3px 8px rgba(0,0,0,0.25); animation: fall-game-item linear forwards; user-select: none; -webkit-user-select: none;
             text-shadow: 0 1px 1px rgba(0,0,0,0.2);
         }
         @keyframes fall-game-item { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(calc(100vh + 80px)) rotate(720deg); } }
         .hongbao { background-color: #e53935; border: 2px solid #ffeb3b; color: #ffeb3b; } .hongbao::before { content: 'ç¦'; }
         .green-envelope { background-color: #4CAF50; border: 2px solid #C8E6C9; color: #C8E6C9; font-size: 28px; } .green-envelope::before { content: 'ğŸ’š'; }
         .mouse-item { background-color: #795548; border: 2px solid #A1887F; color: #A1887F; font-size: 30px; height: 55px; } .mouse-item::before { content: 'ğŸ€'; }

         #game-result {
             margin-top: 20px; padding: 25px 35px; font-size: 1.2em; text-align: center;
             display: none; max-width: 90%; background-color: rgba(255, 255, 255, 0.9);
         }
         #game-result-text { margin-bottom: 25px; line-height: 1.5; }
         #game-result .prize-code { margin-top: 10px; font-weight: bold; color: #e53935; word-break: break-all; font-size: 1.1em; }
         #game-result-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
         #back-from-game { margin-top: 25px; }

         /* --- Slot Machine Styles --- */
         #slot-machine-view { z-index: 85; }
         .slot-machine-box h2 { margin-top: 0; margin-bottom: 20px; color: #ff75ac; font-size: 1.4em; }
         #slot-display-area { display: flex; justify-content: center; margin-bottom: 25px; gap: 15px; }
         .slot {
             display: inline-block; width: 60px; height: 80px; line-height: 80px; font-size: 40px; text-align: center;
             border: 2px solid #ffc2d1; border-radius: 10px; background-color: rgba(255, 255, 255, 0.8);
             box-shadow: inset 0 0 8px rgba(0,0,0,0.1); transition: transform 0.1s ease-out;
         }
         .slot.spinning { transform: scale(0.9); }
         #slot-result-message { min-height: 3em; margin-bottom: 20px; font-size: 1.1em; font-weight: 500; color: #6f42c1; padding: 0 10px; }
         #slot-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 20px; margin-bottom: 10px; }

         /* --- Slot Winnings Button --- */
         .show-slot-winnings-button { padding: 8px 15px; font-size: 0.9em; margin-top: 15px; }

         /* --- æ–°å¢ï¼šå¼¹å‡ºå¼å¥–å“å¯¹è¯æ¡†æ ·å¼ --- */
         .popup-dialog {
             position: fixed; /* å›ºå®šåœ¨å±å¹•ä¸Š */
             top: 20px;       /* è·ç¦»é¡¶éƒ¨ 20px */
             right: 20px;      /* è·ç¦»å³ä¾§ 20px */
             z-index: 1000;   /* ç¡®ä¿åœ¨æ¸¸æˆå…ƒç´ ä¹‹ä¸Š */
             max-width: 280px; /* æœ€å¤§å®½åº¦ */
             width: calc(100% - 40px); /* é€‚åº”å°å±å¹• */
             display: none;   /* åˆå§‹éšè— */
             opacity: 0;      /* åˆå§‹é€æ˜ */
             transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* è¿‡æ¸¡æ•ˆæœ */
             transform: translateY(-10px); /* åˆå§‹å‘ä¸Šåç§»ä¸€ç‚¹ */
             pointer-events: none; /* éšè—æ—¶ä¸å¯äº¤äº’ */
         }

         .popup-dialog.visible {
             display: block;
             opacity: 1;
             transform: translateY(0); /* æ¢å¤æ­£å¸¸ä½ç½® */
             pointer-events: auto; /* å¯è§æ—¶å¯äº¤äº’ */
         }

         .popup-dialog-box {
             background-color: rgba(255, 255, 255, 0.7);
             backdrop-filter: blur(8px) saturate(110%);
             -webkit-backdrop-filter: blur(8px) saturate(110%);
             box-shadow: 0 4px 15px rgba(0,0,0,0.15);
             border: 1px solid rgba(255, 255, 255, 0.25);
             color: #333;
             border-radius: 12px;
             padding: 15px 20px; /* å†…è¾¹è· */
             text-align: left; /* å†…å®¹å·¦å¯¹é½ */
         }

         @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
            .popup-dialog-box {
                background-color: rgba(255, 222, 233, 0.95); /* ä¸æ”¯æŒæ¯›ç»ç’ƒçš„é™çº§èƒŒæ™¯ */
            }
         }

         .popup-dialog-box h2 {
             margin-top: 0;
             margin-bottom: 10px;
             font-size: 1.1em;
             color: #e83e8c; /* Pink */
             text-align: center; /* æ ‡é¢˜å±…ä¸­ */
         }

         #prize-dialog-content ul {
             list-style: none; /* ç§»é™¤åˆ—è¡¨é»˜è®¤æ ·å¼ */
             padding: 0;
             margin: 0 0 15px 0; /* åˆ—è¡¨ä¸‹æ–¹ç•™ç™½ */
             font-size: 0.95em;
             line-height: 1.5;
         }
         #prize-dialog-content li {
             margin-bottom: 5px; /* åˆ—è¡¨é¡¹é—´è· */
         }

         #close-prize-dialog {
             display: block; /* è®©æŒ‰é’®ç‹¬å ä¸€è¡Œ */
             margin: 0 auto; /* å±…ä¸­æŒ‰é’® */
             /* ä½¿ç”¨å°æŒ‰é’®æ ·å¼ */
         }

         /* --- ç§»é™¤æ—§æ ·å¼ (æ— éœ€ä¿ç•™) --- */


         /* Media Query Adjustments */
         @media (max-width: 600px) {
              .modal-content-box { padding: 20px 25px; }
              #love-warning-message { font-size: 1.3em; padding: 20px 30px; }
              #game-start-warning-box p { font-size: 1em; }
              #password-prompt-box h2 { font-size: 1.1em; }
              #password-input { padding: 10px; margin-bottom: 15px; width: 100px; }
              #game-info { font-size: 1em; min-width: 220px; padding: 10px 20px;}
              #game-result { font-size: 1.1em; padding: 20px 25px;}
              #photo-slideshow-container { max-width: 95%; padding: 10px; }
              .slideshow-nav { width: 35px; height: 35px; font-size: 1.3em; }
              .slideshow-nav.prev { left: 5px; } .slideshow-nav.next { right: 5px; }
              .dot { width: 8px; height: 8px; margin: 0 4px;}
              #audio-player-container { max-width: 280px; padding: 8px 12px; gap: 8px; border-radius: 12px;}
              #love-letter-view { padding-top: 45px; margin-top: 30px; border-radius: 12px; }
              #love-letter-view::before { border-width: 45px 0 0 calc(50vw - 10px); border-top-left-radius: 12px;}
              #love-letter-view::after { border-width: 0 0 45px calc(50vw - 10px); border-top-right-radius: 12px;}
              #cat-pendant { width: 50px; height: 50px; top: 10px; left: 10px; }
              #cat-dialog { font-size: 0.8em; min-width: 150px; left: 115%; padding: 10px 15px; border-radius: 10px;}
              #slideshow-caption { font-size: 0.9em;}
              #love-letter-view .signature { font-size: 0.9em; }
              .styled-button { font-size: 0.9em; padding: 10px 15px; }
              .back-button, #close-prize-dialog /* Updated ID */ { padding: 10px 15px; font-size: 0.9em; }
              .small-button { padding: 6px 10px; font-size: 0.8em; }
              .slot { width: 50px; height: 70px; line-height: 70px; font-size: 35px; }
              #slot-result-message { font-size: 1em; }
              .show-slot-winnings-button { padding: 6px 10px; font-size: 0.8em; }
              #love-letter-view h1 { display: block; margin-right: 0; margin-bottom: 5px; }
              #love-letter-view #font-toggle-button { display: block; margin: 5px auto 15px auto; padding: 8px 14px; font-size: 0.9em; }
              .popup-dialog { max-width: 240px; } /* Adjust dialog size on smaller screens */
         }
         @media (max-width: 360px) {
              .modal-content-box { padding: 15px 20px; }
              #love-warning-message { font-size: 1.1em; padding: 15px 20px; }
              #game-start-warning-box p { font-size: 0.9em; }
              #password-prompt-box h2 { font-size: 1em; }
              #password-input { padding: 8px; margin-bottom: 12px; width: 90px; font-size: 1em;}
              #game-info { font-size: 0.9em; min-width: 180px; padding: 8px 15px;}
              #game-result { font-size: 1em; padding: 15px 20px;}
              #birthday-view h1, #love-letter-view h1 { font-size: 1.5em; }
              #love-letter-view h1 { padding: 0 25px; }
              #love-letter-view h1::before, #love-letter-view h1::after { font-size: 0.8em; }
              #birthday-message { font-size: 1.3em; }
              #love-letter-view p { font-size: 0.92em; text-indent: 1.5em; }
              #love-letter-view .signature { font-size: 0.8em; }
              .falling-item { font-size: 20px; } .pointer-heart { font-size: 18px; }
              #audio-player-container { width: 95%; gap: 5px; padding: 6px 10px; max-width: 95%; border-radius: 10px;}
              #play-pause-button { width: 35px; height: 35px; font-size: 1.1em; }
              .time-display { font-size: 0.7em; } #song-title { font-size: 0.7em; }
              #seek-bar::-webkit-slider-thumb { width: 12px; height: 12px; }
              #seek-bar::-moz-range-thumb { width: 12px; height: 12px; }
              #cat-pendant { width: 45px; height: 45px; }
              #cat-dialog { left: 120%; padding: 8px 12px; border-radius: 8px;}
              .love-letter-buttons { margin-top: 20px; }
              .styled-button { font-size: 0.85em; padding: 8px 12px; margin: 4px; border-radius: 6px;}
              .back-button, #close-prize-dialog /* Updated ID */ { padding: 8px 12px; font-size: 0.85em; }
              .small-button { padding: 5px 8px; font-size: 0.75em; }
              .slot { width: 40px; height: 60px; line-height: 60px; font-size: 30px; }
              #slot-display-area { gap: 10px; }
              .slot-machine-box h2 { font-size: 1.2em; }
              #slot-result-message { font-size: 0.9em; }
              .popup-dialog { max-width: 200px; top: 10px; right: 10px; width: calc(100% - 20px); }
         }

     </style>
 </head>
 <body>
     <div id="love-warning-message">è­¦å‘Šï¼ä½ å·²è¿›å…¥æ¹–å—ç¬¬ä¸€æ·±æƒ…çš„å”¯ä¸€åçˆ±åå•ï¼</div>

     <div id="slot-machine-view" class="overlay-view">
         <div class="modal-content-box slot-machine-box">
             <h2>å¹¸è¿æŠ½å¥– âœ¨</h2>
             <div id="slot-display-area">
                 <span class="slot">?</span>
                 <span class="slot">?</span>
                 <span class="slot">?</span>
             </div>
             <div id="slot-result-message">ç‚¹å‡»â€œå¼€å§‹â€è¯•è¯•æ‰‹æ°”å§ï¼</div>
             <div id="slot-buttons">
                 <button id="spin-button" class="styled-button">ç»§ç»­æŠ½å¥–</button>
                 <button id="proceed-to-hongbao-game" class="styled-button" style="display: none;">å¼€å§‹çº¢åŒ…æ¸¸æˆ</button>
                 <button id="back-from-slot-machine" class="styled-button back-button">è¿”å›æƒ…ä¹¦</button>
             </div>
              <button class="show-slot-winnings-button styled-button">æŸ¥çœ‹å¥–å“</button>
         </div>
     </div>

     <div id="prize-dialog-view" class="popup-dialog">
         <div class="popup-dialog-box">
             <h2>å½“å‰å¹¸è¿å¥–å“ ğŸ’°</h2>
             <div id="prize-dialog-content">
                 <ul><li>åŠ è½½ä¸­...</li></ul>
             </div>
             <button id="close-prize-dialog" class="styled-button small-button">å…³é—­</button>
         </div>
     </div>


     <div id="password-prompt-view" class="overlay-view">
         <div id="password-prompt-box" class="modal-content-box">
             <h2>æˆ‘ä»¬è®¤è¯†çš„æ—¶é—´æ˜¯ï¼Ÿ</h2>
             <input type="text" id="password-input" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="4ä½æ•°å­—">
             <button id="password-submit-button" class="styled-button">ç¡®è®¤</button>
             <div id="password-error-message"></div>
         </div>
     </div>

     <div id="game-start-warning" class="overlay-view">
         <div id="game-start-warning-box" class="modal-content-box">
             <p>æ¸¸æˆè¯´æ˜ï¼š<br>æ‚¨æŠ¢å®Œçº¢åŒ…ä»¥åæˆªå›¾æ‰¾å°‘çˆ·å…‘æ¢ï¼Œä¸€å…±å¯ä»¥ç©ä¸‰å±€ï¼Œä¸€å±€30ç§’ï¼Œæ¯å±€æœ€å¤šæŠ•æ”¾50ä¸ªç‰©å“ï¼ˆçº¢åŒ…ã€ç»¿åŒ…ã€è€é¼ ï¼‰ã€‚<br>â¤ï¸ çº¢åŒ…(+1å…ƒ) ğŸ’š ç»¿åŒ…(-1å…ƒ) ğŸ€ è€é¼ (-3å…ƒ)</p>
             <button id="confirm-start-game" class="styled-button">å¼€å§‹æ¸¸æˆ</button>
         </div>
     </div>

     <div id="cat-pendant">
         <img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/static-cat-placeholder.png" alt="çŒ«å’ªæŒ‚ä»¶ (ç‚¹å‡»æ‰“æ»š)">
         <div id="cat-dialog"></div>
     </div>

     <div id="background-layer"></div>
     <div id="background-overlay"></div>

     <div id="birthday-view">
         <h1>âœ¨ çŠçŠå®å®ç”Ÿæ—¥å¿«ä¹ âœ¨</h1>
         <div class="birthday-container">
             <a id="birthday-cake-link" href="#">
                 <img id="birthday-cake" src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/cake-placeholder.jpg" alt="ç”Ÿæ—¥è›‹ç³• (ç‚¹å‡»æœ‰æƒŠå–œ)">
             </a>
             <p id="birthday-message">æœ¬å°‘çˆ·ç¥ä½ ç®€ç®€å•å•ï¼Œå¿«å¿«ä¹ä¹ï¼Œå¹¸å¹¸ç¦ç¦çš„è¿‡å®Œ21å²ã€‚</p>
             <p class="footer-text">ç¥ä½ æ‹¥æœ‰ç¾å¥½çš„ä¸€å¤©ï¼ (ç‚¹å‡»è›‹ç³•æœ‰æƒŠå–œå“¦!)</p>
         </div>
         <div id="photo-slideshow-container">
             <div id="slideshow-wrapper">
                 <div id="slideshow">
                     <div class="slide"><img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/placeholder1.jpg" alt="çŠçŠçš„ç…§ç‰‡ 1"></div>
                     <div class="slide"><img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/placeholder2.jpg" alt="çŠçŠçš„ç…§ç‰‡ 2"></div>
                     <div class="slide"><img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/placeholder3.png" alt="çŠçŠçš„ç…§ç‰‡ 3"></div>
                     <div class="slide"><img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/placeholder4.jpg" alt="çŠçŠçš„ç…§ç‰‡ 4"></div>
                     <div class="slide"><img src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/placeholder5.png" alt="çŠçŠçš„ç…§ç‰‡ 5"></div>
                 </div>
             </div>
             <button class="slideshow-nav prev styled-button" aria-label="ä¸Šä¸€å¼ ">ğŸ‚</button>
             <button class="slideshow-nav next styled-button" aria-label="ä¸‹ä¸€å¼ ">ğŸ‚</button>
             <div class="dots-container"></div>
             <div id="slideshow-caption">ç…§ç‰‡æè¿°ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
         </div>
         <hr>
         <p class="footer-text">çŠçŠï¼Œç”Ÿæ—¥å¿«ä¹ï¼</p>
         <p class="footer-text">ğŸ’å°çŒ´å­åˆé•¿å¤§ä¸€å²å•¦ã€‚æ„¿è¿™ä¸€å¹´ï¼Œæ¸©æš–å’Œå¥½è¿éƒ½å¥”ä½ è€Œæ¥ï¼Œæ‰€æœ‰çš„ä»˜å‡ºéƒ½æœ‰å›æŠ¥ï¼Œæ‰€æœ‰çš„ç¬‘å®¹éƒ½å‘è‡ªçœŸå¿ƒã€‚å¸Œæœ›ä½ èƒ½æ„Ÿå—åˆ°ï¼Œä¸€ç›´æœ‰äººåœ¨é»˜é»˜å…³å¿ƒå’Œç¥ç¦ç€ä½ ã€‚æœªæ¥çš„æ—¥å­ï¼Œæ— è®ºæ™´é›¨ï¼Œå¸Œæœ›èƒ½æœ‰æœºä¼šç»§ç»­åˆ†äº«å½¼æ­¤çš„é£æ™¯~</p>
     </div>

     <div id="love-letter-view">
         <h1>è‡´ æˆ‘ç‹¬ä¸€æ— äºŒçš„ã€æœ€ç‰¹åˆ«çš„çŠçŠ â¤ï¸</h1>
         <button id="font-toggle-button" class="styled-button">åˆ‡æ¢å­—ä½“</button>
         <p>æç¬”æƒ³ç»™ä½ å†™ç‚¹ä»€ä¹ˆï¼Œå°¤å…¶æ˜¯åœ¨ä½ ç”Ÿæ—¥å°†è¿‘çš„æ—¥å­ï¼Œå¿ƒæƒ…æœ‰ç‚¹åƒé‚£æ¬¡å’Œä½ çº¿ä¸‹è§é¢æ—¶â€”â€”æ—¢æœŸå¾…åˆç´§å¼ ï¼Œè¿˜å¸¦ç€ç‚¹æˆ‘ä»¬ä¹‹é—´ç‰¹æœ‰çš„â€œç™«â€ã€‚å¿«ä¸€å¹´äº†ï¼Œæ—¶é—´å¥½åƒè¿‡å¾—é£å¿«ï¼Œåˆå¥½åƒæ¯ä¸€å¤©çš„èŠå¤©éƒ½å€¼å¾—è¢«ç»†ç»†å›å‘³ã€‚</p>
         <p>è¿˜è®°å¾—å—ï¼Ÿä»æœ€åˆé‚£ä¸ªå«æˆ‘â€œå°å±å­©â€æ€¼å¾—æˆ‘å·®ç‚¹æ‹‰é»‘ä½ çš„â€œå¼ ä¸‰â€ï¼ˆå½“ç„¶æ˜¯ç©ç¬‘ï¼Œæˆ‘å“ªé‡Œèˆå¾—æ‹‰é»‘çš‡åå¨˜å¨˜ï¼‰ï¼Œåˆ°åæ¥é‚£ä¸ªä¼šå‘ææ€ªè¡¨æƒ…åŒ…ã€ä¼šåœ¨è¯­éŸ³é‡Œå·ç¬‘çš„â€œçš‡åå¨˜å¨˜â€ï¼Œå†åˆ°é‚£ä¸ªå˜´ä¸Šè¯´ç€â€œä¸è°ˆæ‹çˆ±â€ã€â€œæˆ‘å°±æ˜¯æ¸£å¥³â€ï¼Œå´ä¼šå› ä¸ºæ‹…å¿ƒæˆ‘è€Œé€€å›çº¢åŒ…ã€ä¼šå› ä¸ºæˆ‘éœ€è¦è€Œç”¨èŠ±å‘—ä¹°é¼ æ ‡ã€ä¼šåœ¨æˆ‘â€œå‘ç™«â€åä¾ç„¶ä¸»åŠ¨é—®æ—©çš„â€œå‚»å§‘å¨˜â€â€¦â€¦ä½ èº«ä¸Šè¿™ç§çŸ›ç›¾åˆçœŸå®çš„å¯çˆ±ï¼Œå°±åƒæ‹†ç›²ç›’ï¼Œæ€»èƒ½ç»™æˆ‘æ„æƒ³ä¸åˆ°çš„æƒŠå–œã€‚</p>
         <p>ä»¥å‰æ€»è§‰å¾—ä¸–äº‹çº·æ‰°ï¼Œäººå¿ƒå¤æ‚éš¾æµ‹ï¼Œç›´åˆ°é‡è§ä½ ï¼Œæ‰æ˜ç™½é‚£å¥â€œä¼—é‡Œå¯»ä»–åƒç™¾åº¦ï¼Œè“¦ç„¶å›é¦–ï¼Œé‚£äººå´åœ¨ï¼Œç¯ç«é˜‘çŠå¤„â€æˆ–è®¸æ˜¯çœŸçš„ã€‚ ä½ çš„å‡ºç°ï¼Œåƒä¸€é“å…‰ï¼Œç…§äº®äº†æˆ‘ä¹‹å‰å¯èƒ½æœ‰äº›ç°æš—å’Œå……æ»¡â€œç²¾ç¥å†…è€—â€çš„ä¸–ç•Œã€‚æ˜¯ä½ ç”¨ä½ çš„â€œç™«â€ã€ä½ çš„å–„è‰¯ã€ä½ çš„åŸåˆ™ï¼Œè¿˜æœ‰ä½ é‚£é¢å¯¹ç”Ÿæ´»ä¸æ˜“æ—¶çš„éŸ§æ€§ï¼Œè®©æˆ‘è§‰å¾—è¿™ä¸ªä¸–ç•ŒåŸæ¥è¿˜å¯ä»¥è¿™ä¹ˆæœ‰è¶£å’Œå€¼å¾—æœŸå¾…ã€‚å’Œä½ èŠå¤©æˆäº†æˆ‘æ¯å¤©é›·æ‰“ä¸åŠ¨çš„ä¹ æƒ¯å’Œæœ€å¤§çš„ä¹è¶£ï¼Œä½ åˆ†äº«çš„æ—¥å¸¸çç¢ï¼Œåœ¨æˆ‘è¿™é‡Œéƒ½å˜æˆäº†å€¼å¾—çè—çš„é£æ™¯ã€‚</p>
         <p>æˆ‘çŸ¥é“ï¼Œæˆ‘ä»¬ä¹‹é—´è¿™ç§â€œç¾ç»Šâ€å¾ˆç‰¹åˆ«ï¼Œæ·±åˆ°æœ‰æ—¶è¿æˆ‘ä»¬è‡ªå·±éƒ½éš¾ä»¥ç®€å•å®šä¹‰ã€‚æ²¡å…³ç³»ï¼Œâ€œèº«æ— å½©å‡¤åŒé£ç¿¼ï¼Œå¿ƒæœ‰çµçŠ€ä¸€ç‚¹é€šâ€ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘è§‰å¾—ä½ æ‡‚æˆ‘å†…å¿ƒé‚£äº›æœªè¯´å‡ºå£çš„ç„¦è™‘å’ŒæœŸç›¼ï¼Œæˆ‘ä¹Ÿåœ¨åŠªåŠ›å»ç†è§£ä½ é‚£å¥â€œæ…¢æ…¢æ¥å§â€èƒŒåå¯èƒ½éšè—çš„é¡¾è™‘å’Œéœ€è¦ã€‚æ„Ÿè°¢ä½ æ„¿æ„å‘æˆ‘æ•å¼€é‚£ä¹ˆå¤šï¼Œä¿¡ä»»æˆ‘è¿™ä¹ˆå¤šã€‚</p>
         <p>æˆ‘ä¹ŸçŸ¥é“ï¼Œä½ å¿ƒé‡Œå¯èƒ½è£…ç€å¯¹è¿‡å»çš„æ‹…å¿§ï¼Œå¯¹æœªæ¥çš„ä¸ç¡®å®šï¼Œå¯¹â€œå…³ç³»â€æœ¬èº«çš„ææƒ§ã€‚æˆ‘ä¸ä¼šå†åƒä»¥å‰é‚£æ ·ï¼Œæ€¥åˆ‡åœ°é€¼ä½ ç»™ä¸€ä¸ªç­”æ¡ˆï¼Œä¹Ÿä¸ä¼šå†å¼€é‚£äº›ä¸åˆæ—¶å®œçš„ç©ç¬‘äº†ï¼ˆå¦‚æœæˆ‘åˆâ€œç™«â€äº†ï¼Œè®°å¾—ç”¨è¡¨æƒ…åŒ…æé†’æˆ‘å“¦ï¼‰ã€‚ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘æœ€å¤§çš„ã€ä¹Ÿæ˜¯å”¯ä¸€çš„å¿ƒæ„¿ï¼Œå°±æ˜¯ä½ èƒ½çœŸæ­£åœ°ã€æ¯«æ— è´Ÿæ‹…åœ°å¼€å¿ƒã€‚ä½ æƒ³æ€ä¹ˆè¿‡ï¼Œæˆ‘éƒ½æ”¯æŒã€‚</p>
         <p>è¿™å°ä¿¡ï¼Œä¸æ˜¯ä¸ºäº†åœ¨ç”Ÿæ—¥è¿™å¤©ç»™ä½ å‹åŠ›ï¼ŒçœŸçš„ã€‚å®ƒå°±æ˜¯ä¸€ä»½è¿Ÿæ¥çš„æ„Ÿè°¢ä¿¡â€”â€”æ„Ÿè°¢ç¼˜åˆ†è®©æˆ‘ä»¬ç›¸é‡ï¼Œæ„Ÿè°¢ä½ é™ªæˆ‘åº¦è¿‡è¿™ä¹ˆå¤šæ—¶å…‰ï¼Œåˆ†äº«è¿™ä¹ˆå¤šæ¬¢ç¬‘å’Œ emo çš„ç¬é—´ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä»½å¿ƒæ„ä¹¦â€”â€”å‘Šè¯‰ä½ ï¼Œåœ¨æˆ‘å¿ƒé‡Œï¼Œä½ æœ‰å¤šä¹ˆé‡è¦å’Œç‹¬ä¸€æ— äºŒã€‚</p>
         <p>è‡³äºæœªæ¥ï¼Œæˆ‘ä»¬ç»§ç»­â€œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥â€å§ã€‚â€œäººç”Ÿåˆ°å¤„çŸ¥ä½•ä¼¼ï¼Œåº”ä¼¼é£é¸¿è¸é›ªæ³¥ã€‚â€ æœªæ¥ä¸å¯é¢„çŸ¥ï¼Œä½†é‡è¦çš„æ˜¯ï¼Œæˆ‘å¸Œæœ›èƒ½ç»§ç»­é™ªåœ¨ä½ èº«è¾¹ï¼Œå’Œä½ ä¸€èµ·é¢å¯¹è·¯ä¸Šçš„é£æ™¯ï¼Œæ— è®ºæ˜¯æ™´æ˜¯é›¨ã€‚æ„¿å¦‚æ­¤ç¼˜ï¼Œèƒ½ç»­ç»å¹´ã€‚</p>
         <p>ç”Ÿæ—¥å¿«ä¹ï¼Œæˆ‘æœ€çè§†çš„çŠçŠã€‚</p>
         <div class="signature">é‚£ä¸ªè¶Šæ¥è¶Šæ‡‚å¾—çæƒœä½ çš„â€œç™«å…¬â€ï¼Œå“¥å“¥æˆ–è€…å°‘çˆ·ï¼Œ<br>ç« å•¸å®‡</div>

         <div class="love-letter-buttons">
             <button class="back-button styled-button">è¿”å›ä¸»é¡µé¢</button>
             <button id="goto-game-button" class="styled-button">å»ç©æ¸¸æˆ</button>
         </div>
     </div>

     <div id="game-view" class="overlay-view">
         <div id="game-info" class="modal-content-box"> <span id="round-display">ç¬¬ 1 å±€</span> |
             <span id="score-display">å½“å‰æ€»å¾—åˆ† 0 å…ƒ</span> |
             æ—¶é—´: <span id="timer-display">30</span>s
         </div>
         <div id="game-area"></div>
         <div id="game-result" class="modal-content-box"> <div id="game-result-text"></div>
             <div id="game-result-buttons">
                 <button id="continue-game-button" class="styled-button">ç»§ç»­ä¸‹ä¸€å±€</button>
                 <button id="redeem-early-button" class="styled-button">ç›´æ¥å…‘æ¢</button>
             </div>
         </div>
         <button class="show-slot-winnings-button styled-button">æŸ¥çœ‹å¥–å“</button>
         <button id="back-from-game" class="styled-button">è¿”å›æƒ…ä¹¦</button>
     </div>

     <div id="audio-player-container">
         <audio id="audio-element" loop>
             <source src="https://123456-1327245719.cos.ap-guangzhou.myqcloud.com/zss/M5000044Nr9A4ZiFFQ.mp3" type="audio/mpeg">
             ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾éŸ³é¢‘ã€‚
         </audio>
         <button id="play-pause-button" aria-label="æ’­æ”¾"><span class="play-icon"></span></button>
         <div class="audio-controls-right">
             <div id="song-title">ç”Ÿæ—¥å¿«ä¹æ­Œ</div>
             <input type="range" id="seek-bar" value="0" max="100" step="1" aria-label="è¿›åº¦æ¡">
             <div class="time-display">
                 <span id="current-time">0:00</span>
                 <span id="duration">0:00</span>
             </div>
         </div>
     </div>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Initializing...");
    
            // --- Get Elements ---
            const birthdayView = document.getElementById('birthday-view');
            const loveLetterView = document.getElementById('love-letter-view');
            const cakeLink = document.getElementById('birthday-cake-link');
            const backButton = loveLetterView.querySelector('.back-button');
            const audioElement = document.getElementById('audio-element');
            const catMeowSound = document.getElementById('cat-meow-sound'); // Get cat meow audio
            const audioPlayerContainer = document.getElementById('audio-player-container');
            const playPauseButton = document.getElementById('play-pause-button');
            const playIcon = playPauseButton ? playPauseButton.querySelector('.play-icon') : null;
            const seekBar = document.getElementById('seek-bar');
            const currentTimeDisplay = document.getElementById('current-time');
            const durationDisplay = document.getElementById('duration');
            const slideshowContainer = document.getElementById('photo-slideshow-container');
            const catPendant = document.getElementById('cat-pendant');
            const catDialog = document.getElementById('cat-dialog');
            const fontToggleButton = document.getElementById('font-toggle-button');
            const slideshow = document.getElementById('slideshow');
            const slides = document.querySelectorAll('.slide');
            const prevButton = document.querySelector('.slideshow-nav.prev');
            const nextButton = document.querySelector('.slideshow-nav.next');
            const dotsContainer = document.querySelector('.dots-container');
            const slideshowCaption = document.getElementById('slideshow-caption');
            const loveWarningMessage = document.getElementById('love-warning-message');
            const gameView = document.getElementById('game-view');
            const gotoGameButton = document.getElementById('goto-game-button');
            const backFromGameButton = document.getElementById('back-from-game');
            const gameArea = document.getElementById('game-area');
            const roundDisplay = document.getElementById('round-display');
            const scoreDisplay = document.getElementById('score-display'); // Birthday game score
            const timerDisplay = document.getElementById('timer-display');
            const gameResultDisplay = document.getElementById('game-result');
            const gameResultText = document.getElementById('game-result-text');
            const gameResultButtons = document.getElementById('game-result-buttons');
            const continueGameButton = document.getElementById('continue-game-button');
            const redeemEarlyButton = document.getElementById('redeem-early-button');
            const gameStartWarning = document.getElementById('game-start-warning');
            const confirmStartGameButton = document.getElementById('confirm-start-game');
            const gameInfo = document.getElementById('game-info');
            const passwordPromptView = document.getElementById('password-prompt-view');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmitButton = document.getElementById('password-submit-button');
            const passwordErrorMessage = document.getElementById('password-error-message');
            const slotMachineView = document.getElementById('slot-machine-view');
            const slotDisplayArea = document.getElementById('slot-display-area');
            const slotResultMessage = document.getElementById('slot-result-message');
            const spinButton = document.getElementById('spin-button');
            const proceedToHongbaoGameButton = document.getElementById('proceed-to-hongbao-game');
            const backFromSlotMachineButton = document.getElementById('back-from-slot-machine');
            const showSlotWinningsButtons = document.querySelectorAll('.show-slot-winnings-button');
            const prizeDialogView = document.getElementById('prize-dialog-view');
            const prizeDialogContent = document.getElementById('prize-dialog-content');
            const closePrizeDialogButton = document.getElementById('close-prize-dialog');
            const slots = slotDisplayArea ? slotDisplayArea.querySelectorAll('.slot') : [];
    
            // --- Variables ---
            let birthdayIntervalId = null, loveLetterIntervalId = null;
            const birthdayItems = ['ğŸ‚', 'ğŸŒ¸'], loveLetterItems = ['â¤ï¸', 'ğŸ‚'];
            const BIRTHDAY_INTERVAL_TIME = 550, LOVE_LETTER_INTERVAL_TIME = 500;
            let currentSlideIndex = 0, slideInterval = null;
            const slideCount = slides ? slides.length : 0;
            const SLIDESHOW_INTERVAL_TIME = 5000;
            let catDialogTimeout = null;
            const slideCaptions = ["å†¬æ—¥æš–æ„ï¼Œå›´å·¾å’Œä½ ã€‚ğŸ§£", "åœ¨é€ƒå…¬ä¸»ã®å©šç¤¼å®å½•ğŸ‘‘", "å…³äºä¸»æ’­ä¸Šæ’­åè¢«ç–¯ç‹‚æˆªå±è¿™ä»¶äº‹ğŸ“¸", "ä¸‰æœˆæ•æ‰åˆ°çš„â€˜æ£è›‹é¬¼â€™ï¼è¿™ä¸ªè°ƒçš®åˆå¯çˆ±çš„è¡¨æƒ…ï¼ŒçŠ¯è§„äº†å“¦~ğŸ˜‹", "æ›¿ç« è€æ¿å¥½å¥½é™ªç€å§å§å“¦ï¼Œå²è¿ªå¥‡ï¼ğŸ¤ª"];
            let firstCatClick = true;
            const initialDialog = ["ç½‘é¡µå¼€å‘æ—¥å¿—ï¼š1ä¸ªBUGä¿®äº†8å°æ—¶ğŸ™ƒ"];
            const randomDialogs = ["å–µ~ç« æ€»å’Œå¼ ç¾äººå¤´å‘+1æ ¹", "BUGä¿®å®Œäº†ï¼Ÿä¸ï¼Œæ˜¯å»æ’¸é“äº†ğŸ’ª", "ç‚¹å‡»10æ¬¡è§£é”çŠçŠç«¥å¹´ç…§ğŸ‘€","é“²å±çš„ï¼ˆæŒ‡ç« æ€»ï¼‰è¯´ï¼Œçœ‹è§è¿™ä¸ªé¡µé¢çš„å°ä»™å¥³æœ€å¯çˆ±~ ğŸ¾","æœ¬å–µå®£å¸ƒï¼Œè¿™ä¸ªé¡µé¢99%çš„é¢œå€¼æ˜¯é èƒŒæ™¯å›¾å’ŒçŠçŠé¢œå€¼æ’‘èµ·æ¥çš„ï¼å‰©ä¸‹1%æ˜¯æœ¬å–µçš„å¯çˆ±~ ï¼ˆå°å£°"];
            const rateLimitDialog = "å–µçš„ï¼Œå¥³äººï¼Œåˆ«æ’¸äº†ï¼Œå¿«è¢«ä½ è€—æˆç§ƒå¤´çŒ«å’ªäº†ğŸ˜¡";
            let recentCatClicks = [], isCatRateLimitedCooldownActive = false, catCooldownStartTime = 0;
            const CAT_CLICK_LIMIT = 20, CAT_CLICK_WINDOW = 60000, CAT_COOLDOWN_DURATION = 20000;
            let isSeeking = false;
    
            // Birthday Hongbao Game State (Unaffected by Slot Machine)
            let totalScore = 0; // This holds the score from the falling items game ONLY.
            let currentRound = 0;
            const maxRounds = 3, maxItemsPerRound = 50, maxHongbaoPerRound = 30, maxMicePerRound = 30, maxGreenPerRound = 40;
            let timeLeft = 30, gameTimerInterval = null, itemSpawnInterval = null, gameActive = false;
            let itemsSpawnedThisRound = 0, hongbaoSpawnedThisRound = 0, miceSpawnedThisRound = 0, greenSpawnedThisRound = 0;
            const ITEM_SPAWN_INTERVAL = 400, ITEM_FALL_DURATION = 7000;
    
            // --- Slot Machine State ---
            let slotWinningsTotal = 0; // Slot game state (LUCKY DRAW MONEY)
            const SLOT_WINNINGS_CAP = 50; // Cap for 'ç¦' prize from slot machine
            const slotItems = ['ğŸ‚', 'ç¦', 'â¤ï¸', 'ğŸ“±', 'ğŸ“·', 'ğŸ’‹', 'ğŸ¡', 'âœˆï¸', 'ğŸ’–', 'ğŸ’°', 'ğŸŸï¸']; // Added ALL new emojis including ğŸŸï¸
            const loveQuotes = [ "é‡è§ä½ ä¹‹åï¼Œæ„Ÿè§‰ä¸–ç•Œéƒ½äº®äº†ã€‚â˜€ï¸", "ä½ çš„å–„è‰¯å’ŒçœŸå®ï¼Œåƒæ˜Ÿæ˜Ÿä¸€æ ·é—ªäº®ã€‚ğŸŒŸ", "æƒ³å’Œä½ ä¸€èµ·ï¼Œçœ‹éä¸–é—´ç¹åã€‚âœ¨", "æƒ³ç»™ä½ å¾ˆå¤šå¾ˆå¤šçš„â€œåçˆ±â€å’Œæ¸©æš–ã€‚ğŸğŸ’–", "æˆ‘çš„å¿ƒä¸å¤§ï¼Œåˆšå¥½è£…ä¸‹ä¸€ä¸ªä½ ã€‚ğŸ’–", "ä½ å¥½å¯çˆ±ï¼Œè®©æˆ‘ææè„¸è›‹å¯ä»¥å—ï¼ŸğŸ¤ (åªæ•¢æƒ³æƒ³ğŸ˜‚)" ];
            let hongbaoGameUnlocked = false;
            let isSpinning = false;
            let phoneWon = false;
            let cameraWon = false;
    
            // New Prize State Variables
            let outingPrizeWon = false; let wonOutingItem = null; const outingPrizeName = "å‡ºå»ç©æˆ‘ä¹°å•";
            let travelPrizeWon = false; let wonTravelItem = null; const travelPrizeName = "å›½å†…æ—…æ¸¸ä¸€æ¬¡";
            let servicePrizeWon = false; let wonServiceItem = null; const servicePrizeName = "ä¸“å±æœåŠ¡ä¸€æ¬¡";
            let materialPrizeWon = false; let wonMaterialItem = null; const materialPrizeName = "è´­ç‰©åŸºé‡‘/ä¼šå‘˜";
            let interactionPrizeWon = false; let wonInteractionItem = null; const interactionPrizeName = "ç‰¹æ®Šäº’åŠ¨åˆ¸";
    
            // New Prize Item Lists
            const outingItems = ["ç¾é£Ÿæ¢åº—ä¹‹æ—…", "è½»æ¾è§‚å½±æ—¥", "æ¸¸ä¹åœº/ç”µç©åŸç•…ç©åˆ¸"];
            const travelItems = ["äº‘å—æ—…æ¸¸", "è¥¿åŒ—æ—…æ¸¸", "æµ™æ±Ÿæ—…æ¸¸", "å››å·æ—…æ¸¸", "è¥¿è—æ—…æ¸¸"];
            const serviceItems = ["ä½ ä¸“å±çš„â€˜æ ‘æ´â€™æœåŠ¡ä¸€å°æ—¶", "â€˜åŠä»™â€™è§£æƒ‘ä¸€æ¬¡", "å®šåˆ¶ç‰ˆæƒ…æ­Œ/å°è¯—ä¸€é¦–", "â€˜çŠçŠè¯­å½•â€™è¡¨æƒ…åŒ…ä¸€å¥—", "æœªæ¥ä¸€å‘¨çš„â€˜ä¸“å±å¤©æ°”é¢„æŠ¥å‘˜â€™"];
            const materialItems = ["é›¶é£Ÿ/é¥®æ–™(200å…ƒ)", "åŒ–å¦†å“(300å…ƒ)", "è§†é¢‘/éŸ³ä¹ä¼šå‘˜(ä¸€å¹´)", "ç‹è€…è£è€€çš®è‚¤(200å…ƒ)"];
            const interactionItems = ["æˆ‘çš„â€˜å…æ­»é‡‘ç‰Œâ€™ä¸€æš", "â€˜å½©è™¹å±â€™å¤¸å¤¸æœåŠ¡ååˆ†é’Ÿ", "â€˜åŠä»™å·®é£åˆ¸â€™ä¸€å¼ ", "â€˜æ™šå®‰æ•…äº‹â€™æœåŠ¡ä¸€å‘¨"];
    
            let dragTarget = null, isDragging = false, offsetX, offsetY, isDragAction = false;
            let lastActiveViewId = 'birthday-view';
    
            // --- Utility Functions ---
            function tryPlayBackgroundAudio() { if (audioElement && audioElement.paused) { audioElement.play().then(() => { updatePlayPauseIcon(); }).catch(error => { if (error.name !== 'NotAllowedError') { console.error("å°è¯•æ’­æ”¾èƒŒæ™¯éŸ³ä¹å¤±è´¥:", error); } }); } }
            function tryPlayMeowAudio() { if (catMeowSound) { catMeowSound.currentTime = 0; catMeowSound.play().catch(e => console.error("Error playing meow:", e)); } } // Function to play meow
            function formatTime(seconds) { const secs = Math.floor(seconds || 0); if (isNaN(secs) || secs < 0) return "0:00"; const minutes = Math.floor(secs / 60); const remainingSeconds = secs % 60; return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`; }
            function throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); } } }
            function getRandomItem(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
    
            // --- Falling Items Functions (Generic) ---
            function createFallingItem(itemType, container) { if (!container || container.style.display === 'none') return; const item = document.createElement('div'); item.classList.add('falling-item'); item.style.left = Math.random() * 95 + 'vw'; item.innerText = itemType; item.style.fontSize = (Math.random() * 10 + 18) + 'px'; const fallDuration = Math.random() * 5 + 7; const delay = Math.random() * 4; item.style.setProperty('--random-rotate', (Math.random() * 80 - 40) || 0); item.style.animationDuration = `${fallDuration}s`; item.style.animationDelay = delay + 's'; container.appendChild(item); setTimeout(() => { if (item && item.parentNode) item.remove(); }, (fallDuration + delay) * 1000 + 500); }
            function startFallingItems(intervalId, itemArray, container, intervalTime) { if (intervalId) clearInterval(intervalId); if (!container) return null; const newIntervalId = setInterval(() => { if (container && container.style.display !== 'none') { const randomItem = itemArray[Math.floor(Math.random() * itemArray.length)]; createFallingItem(randomItem, container); } }, intervalTime); return newIntervalId; }
            function stopFallingItems(intervalId, container) { if (intervalId) clearInterval(intervalId); if (container) { const existingItems = container.querySelectorAll('.falling-item'); existingItems.forEach(item => item.remove()); } return null; }
    
            // --- View Switching Logic ---
            function hideAllViews() {
                [birthdayView, loveLetterView, gameView, loveWarningMessage, gameStartWarning, passwordPromptView, slotMachineView] // prizeDialogView is NOT hidden here
                    .forEach(view => {
                        if (view && view.style.display !== 'none' && ['slot-machine-view', 'game-view', 'love-letter-view', 'birthday-view'].includes(view.id)) {
                           lastActiveViewId = view.id;
                        }
                        if (view) view.style.display = 'none';
                    });
                birthdayIntervalId = stopFallingItems(birthdayIntervalId, birthdayView);
                loveLetterIntervalId = stopFallingItems(loveLetterIntervalId, loveLetterView);
                stopGame();
            }
            function showLoveLetter() { hideAllViews(); if(loveLetterView) loveLetterView.style.display = 'block'; loveLetterIntervalId = startFallingItems(loveLetterIntervalId, loveLetterItems, loveLetterView, LOVE_LETTER_INTERVAL_TIME); window.scrollTo(0, 0); updatePlayPauseIcon(); stopSlideshowAutoplay(); }
            function showBirthday() { hideAllViews(); if(birthdayView) birthdayView.style.display = 'block'; birthdayIntervalId = startFallingItems(birthdayIntervalId, birthdayItems, birthdayView, BIRTHDAY_INTERVAL_TIME); window.scrollTo(0, 0); updatePlayPauseIcon(); startSlideshowAutoplay(); }
            function showPasswordPrompt() { hideAllViews(); if (passwordPromptView) passwordPromptView.style.display = 'flex'; if (passwordInput) passwordInput.value = ''; if (passwordErrorMessage) passwordErrorMessage.textContent = ''; window.scrollTo(0, 0); updatePlayPauseIcon(); stopSlideshowAutoplay(); }
            function showGameStartWarning() { hideAllViews(); if (gameStartWarning) gameStartWarning.style.display = 'flex'; window.scrollTo(0, 0); updatePlayPauseIcon(); stopSlideshowAutoplay(); }
            function showGame() { hideAllViews(); if(gameView) { gameView.style.display = 'flex'; if (gameResultDisplay) gameResultDisplay.style.display = 'none'; if (gameArea) gameArea.style.display = 'block'; if (gameInfo) gameInfo.style.display = 'block'; } startGame(); window.scrollTo(0, 0); updatePlayPauseIcon(); stopSlideshowAutoplay(); }
    
            function showSlotMachine() {
                // Reset ONLY slot machine specific state if needed (but user requested no reset unless entering the game section for the first time?)
                // For now, we don't reset slotWinningsTotal or flags here, only when clicking the "å»ç©æ¸¸æˆ" button from the letter.
                // Let's clarify - the original code DID reset on showSlotMachine. We'll keep that behavior.
                console.log("Entering Slot Machine - Resetting ALL game state as per original logic");
                currentRound = 0;
                totalScore = 0; // Reset birthday game score too, as per original code
                slotWinningsTotal = 0; // Reset slot winnings
                hongbaoGameUnlocked = false;
                phoneWon = false;
                cameraWon = false;
                outingPrizeWon = false; wonOutingItem = null;
                travelPrizeWon = false; wonTravelItem = null;
                servicePrizeWon = false; wonServiceItem = null;
                materialPrizeWon = false; wonMaterialItem = null;
                interactionPrizeWon = false; wonInteractionItem = null;
                isSpinning = false; // Ensure spinning stops
    
                hideAllViews(); // Hide other main views
                if (slotMachineView) slotMachineView.style.display = 'flex';
                if (spinButton) { spinButton.textContent = 'å¼€å§‹æŠ½å¥–'; spinButton.disabled = false; } // Always reset button text
                if (slotResultMessage) { slotResultMessage.textContent = 'ç‚¹å‡»â€œå¼€å§‹æŠ½å¥–â€è¯•è¯•æ‰‹æ°”å§ï¼'; } // Reset message
                if (slots.length === 3) { slots.forEach(slot => slot.textContent = '?'); } // Reset slots display
                if (proceedToHongbaoGameButton) { proceedToHongbaoGameButton.style.display = 'none'; } // Hide game button initially
                window.scrollTo(0, 0); updatePlayPauseIcon(); stopSlideshowAutoplay();
            }
    
            function showPrizeDialog() {
                console.log("Showing prize dialog.");
                if (!prizeDialogView || !prizeDialogContent) {
                    console.error("Prize dialog elements not found!");
                    return;
                }
                let combinedTotal = totalScore + slotWinningsTotal; // totalScore = Birthday Hongbao, slotWinningsTotal = Lucky Draw Money
                let prizeHTML = '<ul>';
    
                // Birthday Hongbao Total (Game Score) + Lucky Draw Money (Slot Score)
                 prizeHTML += `<li>æ€»è®¡å¥–é‡‘ ğŸ§§: <span class="prize-status won prize-value">${combinedTotal} å…ƒ</span></li>`;
    
                // Phone Prize
                prizeHTML += `<li>æ–°æ‰‹æœºä¸€éƒ¨ ğŸ“±: <span class="prize-status ${phoneWon ? 'won' : 'pending'}">${phoneWon ? 'å·²è·å¾— (çº¢ç±³ K80 / Oppo Reno 13)' : 'å¾…èµ¢å–'}</span></li>`;
    
                // Camera Prize
                prizeHTML += `<li>ç´¢å°¼ç›¸æœºä¸€å° ğŸ“·: <span class="prize-status ${cameraWon ? 'won' : 'pending'}">${cameraWon ? 'å·²è·å¾—' : 'å¾…èµ¢å–'}</span></li>`;
    
                // New Prizes - Category 1: Outing
                prizeHTML += `<li>${outingPrizeName} ğŸ¡: <span class="prize-status ${outingPrizeWon ? 'won' : 'pending'}">${outingPrizeWon ? `å·²è·å¾— (${wonOutingItem})` : 'å¾…èµ¢å–'}</span></li>`;
    
                // New Prizes - Category 2: Travel
                prizeHTML += `<li>${travelPrizeName} âœˆï¸: <span class="prize-status ${travelPrizeWon ? 'won' : 'pending'}">${travelPrizeWon ? `å·²è·å¾— (${wonTravelItem})` : 'å¾…èµ¢å–'}</span></li>`;
    
                // New Prizes - Category 3: Service
                prizeHTML += `<li>${servicePrizeName} ğŸ’–: <span class="prize-status ${servicePrizeWon ? 'won' : 'pending'}">${servicePrizeWon ? `å·²è·å¾— (${wonServiceItem})` : 'å¾…èµ¢å–'}</span></li>`;
    
                // New Prizes - Category 4: Material
                prizeHTML += `<li>${materialPrizeName} ğŸ’°: <span class="prize-status ${materialPrizeWon ? 'won' : 'pending'}">${materialPrizeWon ? `å·²è·å¾— (${wonMaterialItem})` : 'å¾…èµ¢å–'}</span></li>`;
    
                 // New Prizes - Category 5: Interaction
                prizeHTML += `<li>${interactionPrizeName} ğŸŸï¸: <span class="prize-status ${interactionPrizeWon ? 'won' : 'pending'}">${interactionPrizeWon ? `å·²è·å¾— (${wonInteractionItem})` : 'å¾…èµ¢å–'}</span></li>`;
    
                // Hongbao Game Unlock Status
                prizeHTML += `<li>çº¢åŒ…é›¨æ¸¸æˆ ğŸ‚: <span class="prize-status ${hongbaoGameUnlocked ? 'unlocked' : 'pending'}">${hongbaoGameUnlocked ? 'å·²è§£é”' : 'å¾…è§£é”'}</span></li>`;
    
                // Other potential outcomes (no status needed)
                prizeHTML += `<li>æƒ…è¯ â¤ï¸: (å¯èƒ½æŠ½ä¸­)</li>`;
                prizeHTML += `<li>é£å» ğŸ’‹: (å¯èƒ½æŠ½ä¸­)</li>`;
    
                prizeHTML += '</ul>';
    
                prizeDialogContent.innerHTML = prizeHTML;
                prizeDialogView.classList.add('visible');
            }
    
            function hidePrizeDialog() {
                 console.log("Hiding prize dialog.");
                if (!prizeDialogView) {
                    console.error("Prize dialog view element not found!");
                    return;
                }
                prizeDialogView.classList.remove('visible');
            }
    
            // Removed: function showPrizeInfoAlert() { ... } // Alert is removed
    
            // --- Password Check Logic ---
            if (passwordSubmitButton && passwordInput && passwordErrorMessage) { passwordSubmitButton.addEventListener('click', () => { const enteredPassword = passwordInput.value.trim(); if (enteredPassword === "0610") { showGameStartWarning(); } else { passwordErrorMessage.textContent = 'ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï¼æç¤ºï¼š4ä½æ•°å­—'; passwordInput.value = ''; passwordInput.focus(); } }); passwordInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); passwordSubmitButton.click(); } }); }
    
            // --- Pointer Trail Heart Logic ---
            function createPointerHeart(x, y) { if (!document.body) return; const heart = document.createElement('div'); heart.classList.add('pointer-heart'); heart.innerHTML = 'â¤ï¸'; heart.style.left = `${x}px`; heart.style.top = `${y}px`; document.body.appendChild(heart); setTimeout(() => { if (heart && heart.parentNode) { heart.remove(); } }, 600); }
            const throttledCreateHeart = throttle(createPointerHeart, 100); document.body.addEventListener('mousemove', (event) => { throttledCreateHeart(event.pageX, event.pageY); }); document.body.addEventListener('touchmove', (event) => { if (event.touches.length > 0) { const touch = event.touches[0]; throttledCreateHeart(touch.pageX, touch.pageY); } }, { passive: true }); document.body.addEventListener('touchstart', (event) => { if (event.touches.length > 0) { const touch = event.touches[0]; throttledCreateHeart(touch.pageX, touch.pageY); } }, { passive: true });
    
            // --- Custom Audio Player Logic ---
            function updatePlayPauseIcon() { if (!playIcon || !audioElement || !playPauseButton) return; playIcon.classList.remove('play-icon', 'pause-icon'); if (audioElement.paused || audioElement.ended) { playIcon.classList.add('play-icon'); playPauseButton.setAttribute('aria-label', 'æ’­æ”¾'); } else { playIcon.classList.add('pause-icon'); playPauseButton.setAttribute('aria-label', 'æš‚åœ'); } }
            if (playPauseButton && audioElement) { playPauseButton.addEventListener('click', () => { if (isDragAction) return; if (audioElement.paused || audioElement.ended) { audioElement.play().catch(e => console.error("Error playing audio:", e)); } else { audioElement.pause(); } }); }
            if (audioElement) { audioElement.addEventListener('timeupdate', () => { if (!isSeeking && !isNaN(audioElement.duration) && seekBar && currentTimeDisplay) { try { if(seekBar) seekBar.value = audioElement.currentTime; if(currentTimeDisplay) currentTimeDisplay.textContent = formatTime(audioElement.currentTime); } catch (e) { console.error("Error updating time:", e) } } }); audioElement.addEventListener('loadedmetadata', () => { if (!isNaN(audioElement.duration) && seekBar && durationDisplay) { try { if(seekBar) seekBar.max = audioElement.duration; if(durationDisplay) durationDisplay.textContent = formatTime(audioElement.duration); updatePlayPauseIcon(); } catch (e) { console.error("Error on loadedmetadata:", e) } } else { if(seekBar) seekBar.max = 0; if(durationDisplay) durationDisplay.textContent = "0:00"; } }); audioElement.addEventListener('play', updatePlayPauseIcon); audioElement.addEventListener('pause', updatePlayPauseIcon); audioElement.addEventListener('ended', updatePlayPauseIcon); }
            if (seekBar && currentTimeDisplay && audioElement) { seekBar.addEventListener('input', () => { isSeeking = true; try { if(currentTimeDisplay) currentTimeDisplay.textContent = formatTime(parseFloat(seekBar.value) || 0); } catch (e) { console.error("Error updating seek bar display:", e) } }); seekBar.addEventListener('change', () => { if (!isNaN(audioElement.duration)) { try { audioElement.currentTime = parseFloat(seekBar.value) || 0; } catch (e) { console.error("Error setting audio time:", e) } } isSeeking = false; if (!isSeeking && !isNaN(audioElement.duration) && currentTimeDisplay) { currentTimeDisplay.textContent = formatTime(audioElement.currentTime); } }); }
    
            // --- Slideshow Logic ---
            function updateDots() { if (!dotsContainer || !slides || dotsContainer.children.length !== slideCount) return; for (let i = 0; i < slideCount; i++) { if(dotsContainer.children[i]) dotsContainer.children[i].classList.toggle('active', i === currentSlideIndex); } }
            function showSlide(index) { if (slideCount <= 0 || !slideshow) return; currentSlideIndex = (index + slideCount) % slideCount; const offset = -currentSlideIndex * 100; slideshow.style.transform = `translateX(${offset}%)`; updateDots(); if (slideshowCaption && slideCaptions.length > currentSlideIndex) { slideshowCaption.textContent = slideCaptions[currentSlideIndex]; } else if (slideshowCaption) { slideshowCaption.textContent = ''; } }
            function nextSlide() { showSlide(currentSlideIndex + 1); } function startSlideshowAutoplay() { stopSlideshowAutoplay(); if (slideCount > 1) { slideInterval = setInterval(nextSlide, SLIDESHOW_INTERVAL_TIME); } } function stopSlideshowAutoplay() { clearInterval(slideInterval); slideInterval = null; } if (prevButton && nextButton) { prevButton.addEventListener('click', () => { if (isDragAction) return; stopSlideshowAutoplay(); showSlide(currentSlideIndex - 1); }); nextButton.addEventListener('click', () => { if (isDragAction) return; stopSlideshowAutoplay(); showSlide(currentSlideIndex + 1); }); } function createDots() { if (!dotsContainer || slideCount <= 0) return; dotsContainer.innerHTML = ''; for (let i = 0; i < slideCount; i++) { const dot = document.createElement('span'); dot.classList.add('dot'); dot.dataset.index = i; dot.setAttribute('aria-label', `è·³è½¬åˆ°ç…§ç‰‡ ${i + 1}`); dot.addEventListener('click', (e) => { if (isDragAction) return; stopSlideshowAutoplay(); const index = parseInt(e.target.dataset.index); showSlide(index); }); dotsContainer.appendChild(dot); } updateDots(); } if (slideshowContainer) { slideshowContainer.addEventListener('click', (event) => { if (isDragAction) return; if (!event.target.closest('.slideshow-nav') && !event.target.closest('.dot')) { console.log("Slideshow area clicked (audio trigger removed)."); } }); }
    
            // --- Draggable Elements Logic ---
            function makeDraggable(element) { if (!element) return; element.style.cursor = 'move'; element.addEventListener('dragstart', (e) => e.preventDefault()); element.style.touchAction = 'none'; let startX, startY, elementStartX, elementStartY, pointerId = null, dragThreshold = 5; function getPointerCoords(event) { let touch = null; if (event.touches && event.touches.length > 0) { for (let i = 0; i < event.touches.length; i++) { if (event.touches[i].identifier === pointerId) { touch = event.touches[i]; break; } } if (!touch) touch = event.touches[0]; } else if (event.changedTouches && event.changedTouches.length > 0) { for (let i = 0; i < event.changedTouches.length; i++) { if (event.changedTouches[i].identifier === pointerId) { touch = event.changedTouches[i]; break; } } if (!touch) touch = event.changedTouches[0]; } if (touch) return { x: touch.clientX, y: touch.clientY }; if (event.clientX !== undefined) return { x: event.clientX, y: event.clientY }; return null; } function dragStartHandler(event) { if (event.target !== element && event.target.closest('button, input, a, select, textarea')) { return; } if ((event.type === 'mousedown' && event.button !== 0) || (event.touches && event.touches.length > 1)) { return; } const coords = getPointerCoords(event); if (!coords) return; isDragging = false; isDragAction = false; dragTarget = element; dragTarget.style.transition = 'none'; startX = coords.x; startY = coords.y; const rect = dragTarget.getBoundingClientRect(); elementStartX = rect.left; elementStartY = rect.top; const computedStyle = getComputedStyle(dragTarget); if (computedStyle.position !== 'fixed' && computedStyle.position !== 'absolute') { console.warn("Draggable element is not positioned (fixed/absolute). Dragging might be unexpected.", dragTarget); dragTarget.style.position = 'fixed'; } if (!dragTarget.style.left || dragTarget.style.left === 'auto') { dragTarget.style.left = `${elementStartX}px`; } if (!dragTarget.style.top || dragTarget.style.top === 'auto') { dragTarget.style.top = `${elementStartY}px`; } dragTarget.style.right = 'auto'; dragTarget.style.bottom = 'auto'; dragTarget.style.transform = 'none'; if (event.type === 'mousedown') { pointerId = -1; document.addEventListener('mousemove', draggingHandler); document.addEventListener('mouseup', dragEndHandler); } else if (event.type === 'touchstart') { pointerId = event.touches[0].identifier; document.addEventListener('touchmove', draggingHandler, { passive: false }); document.addEventListener('touchend', dragEndHandler); document.addEventListener('touchcancel', dragEndHandler); } document.body.style.userSelect = 'none'; document.body.style.webkitUserSelect = 'none'; document.body.style.msUserSelect = 'none'; } function draggingHandler(event) { if (!dragTarget) return; const coords = getPointerCoords(event); if (!coords) { dragEndHandler(event); return; } let currentX = coords.x; let currentY = coords.y; const deltaX = currentX - startX; const deltaY = currentY - startY; if (!isDragging && (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold)) { isDragging = true; isDragAction = true; } if (isDragging) { if (event.cancelable && event.type === 'touchmove') { event.preventDefault(); } let newLeft = elementStartX + deltaX; let newTop = elementStartY + deltaY; const parentWidth = window.innerWidth; const parentHeight = window.innerHeight; const elemWidth = dragTarget.offsetWidth; const elemHeight = dragTarget.offsetHeight; newLeft = Math.max(0, Math.min(newLeft, parentWidth - elemWidth)); newTop = Math.max(0, Math.min(newTop, parentHeight - elemHeight)); dragTarget.style.left = `${newLeft}px`; dragTarget.style.top = `${newTop}px`; } } function dragEndHandler(event) { if (!dragTarget) return; let endPointerMatch = false; if (event.type === 'mouseup' && pointerId === -1) { endPointerMatch = true; } else if ((event.type === 'touchend' || event.type === 'touchcancel') && event.changedTouches) { for (let i = 0; i < event.changedTouches.length; i++) { if (event.changedTouches[i].identifier === pointerId) { endPointerMatch = true; break; } } } if (!endPointerMatch && event.type !== 'touchcancel' && event.type !== 'mouseup') { return; } if (pointerId === -1) { document.removeEventListener('mousemove', draggingHandler); document.removeEventListener('mouseup', dragEndHandler); } else { document.removeEventListener('touchmove', draggingHandler); document.removeEventListener('touchend', dragEndHandler); document.removeEventListener('touchcancel', dragEndHandler); } dragTarget.style.transition = ''; document.body.style.userSelect = ''; document.body.style.webkitUserSelect = ''; document.body.style.msUserSelect = ''; if (isDragAction) { const finalRect = dragTarget.getBoundingClientRect(); const finalPosToSave = { x: finalRect.left, y: finalRect.top }; if (element.id === 'audio-player-container') { try { localStorage.setItem('audioPlayerPos', JSON.stringify(finalPosToSave)); } catch (e) { console.error("Failed to save player position:", e); } } else if (element.id === 'cat-pendant') { try { localStorage.setItem('catPosition', JSON.stringify(finalPosToSave)); } catch (e) { console.error("Failed to save cat position:", e); } } } isDragging = false; pointerId = null; dragTarget = null; setTimeout(() => { isDragAction = false; }, 0); } element.addEventListener('mousedown', dragStartHandler); element.addEventListener('touchstart', dragStartHandler, { passive: true }); }
            if (audioPlayerContainer) { const savedPlayerPos = localStorage.getItem('audioPlayerPos'); if (savedPlayerPos) { try { const pos = JSON.parse(savedPlayerPos); if(pos && typeof pos.x === 'number' && typeof pos.y === 'number'){ audioPlayerContainer.style.left = `${pos.x}px`; audioPlayerContainer.style.top = `${pos.y}px`; audioPlayerContainer.style.right = 'auto'; audioPlayerContainer.style.bottom = 'auto'; audioPlayerContainer.style.transform = 'none'; } } catch(e){ console.error("Failed to load player position:", e); } } makeDraggable(audioPlayerContainer); }
            if (catPendant) { const savedCatPos = localStorage.getItem('catPosition'); if (savedCatPos) { try { const pos = JSON.parse(savedCatPos); if(pos && typeof pos.x === 'number' && typeof pos.y === 'number'){ catPendant.style.left = `${pos.x}px`; catPendant.style.top = `${pos.y}px`; catPendant.style.right = 'auto'; catPendant.style.bottom = 'auto'; catPendant.style.transform = 'none'; } } catch(e){ console.error("Failed to load cat position:", e); } } makeDraggable(catPendant); }
    
            // --- Cat Pendant Logic (Updated for Meow) ---
            if (catPendant && catDialog) {
                catPendant.addEventListener('click', () => {
                    if (isDragAction) { console.log("Cat click ignored due to drag."); return; }
                    try {
                        const now = Date.now();
                        let dialogText = "";
                        let canShowDialog = false;
                        let playAnimation = false; // Animation is separate from sound now
    
                        if (isCatRateLimitedCooldownActive) {
                            if (now - catCooldownStartTime >= CAT_COOLDOWN_DURATION) {
                                isCatRateLimitedCooldownActive = false; catCooldownStartTime = 0; console.log("Cat cooldown ended.");
                            } else {
                                dialogText = rateLimitDialog; canShowDialog = true; playAnimation = false;
                            }
                        }
    
                        if (!isCatRateLimitedCooldownActive) {
                            tryPlayMeowAudio(); // Play meow sound regardless of dialog/rate limit
                            recentCatClicks = recentCatClicks.filter(timestamp => now - timestamp < CAT_CLICK_WINDOW);
                            recentCatClicks.push(now);
                            let isRateLimited = recentCatClicks.length >= CAT_CLICK_LIMIT;
    
                            if (isRateLimited) {
                                dialogText = rateLimitDialog; canShowDialog = true; playAnimation = false;
                                isCatRateLimitedCooldownActive = true; catCooldownStartTime = now; console.log("Cat rate limit cooldown started.");
                            } else {
                                 // Only show dialog text for non-rate-limited clicks
                                if (firstCatClick) {
                                    dialogText = initialDialog[0]; firstCatClick = false;
                                } else {
                                    const randomIndex = Math.floor(Math.random() * randomDialogs.length);
                                    dialogText = randomDialogs[randomIndex];
                                }
                                canShowDialog = true;
                                playAnimation = true; // Still play animation for non-rate-limited clicks
                            }
                        }
    
                        // Show Dialog logic
                        if (canShowDialog && catDialog) {
                            catDialog.textContent = dialogText;
                            clearTimeout(catDialogTimeout);
                            catDialog.classList.remove('visible');
                            void catDialog.offsetWidth; // Force reflow
                            catDialog.classList.add('visible');
                            catDialogTimeout = setTimeout(() => { if(catDialog) catDialog.classList.remove('visible'); }, 4000);
                        } else if (!catDialog) {
                            console.error("Cat dialog element not found!");
                        }
    
                        // Play Animation logic (only if not rate limited)
                        if (playAnimation && !catPendant.classList.contains('rolling')) {
                            const currentLeft = catPendant.style.left; const currentTop = catPendant.style.top;
                            catPendant.classList.add('rolling');
                            catPendant.addEventListener('animationend', () => {
                                if(catPendant) { catPendant.classList.remove('rolling'); catPendant.style.left = currentLeft; catPendant.style.top = currentTop; catPendant.style.transform = 'none'; }
                            }, { once: true });
                        }
    
                    } catch (error) {
                        console.error("Error in cat pendant click handler:", error);
                        if (catPendant) catPendant.classList.remove('rolling');
                        if (catDialog) catDialog.classList.remove('visible');
                        clearTimeout(catDialogTimeout);
                    }
                });
                 const catImg = catPendant.querySelector('img');
                 if(catImg) { catImg.onerror = () => { if (catPendant) catPendant.style.display = 'none'; }; }
                 else { if (catPendant) catPendant.style.display = 'none'; }
            } else {
                 if (catPendant) catPendant.style.display = 'none';
            }
    
            // --- Font Toggle Logic ---
            if (fontToggleButton && loveLetterView) { fontToggleButton.addEventListener('click', () => { if (isDragAction) return; loveLetterView.classList.toggle('love-letter-default-font'); }); }
    
            // --- Slot Machine Game Logic (Updated) ---
            function getRandomLoveQuote() { if (loveQuotes.length === 0) return "ä½ å°±æ˜¯æˆ‘æœ€å¥½çš„æƒ…è¯ã€‚"; return loveQuotes[Math.floor(Math.random() * loveQuotes.length)]; }
    
            function spinSlots() {
                if (isSpinning || !slots || slots.length !== 3 || !slotResultMessage) return;
    
                isSpinning = true;
                if (spinButton) spinButton.disabled = true;
                if (slotResultMessage) slotResultMessage.textContent = "è½¬åŠ¨ä¸­...";
    
                let spinCycles = 0;
                const maxCycles = 15; // Adjust for desired spin duration
                const spinInterval = setInterval(() => {
                    slots.forEach(slot => {
                        slot.textContent = slotItems[Math.floor(Math.random() * slotItems.length)];
                        slot.classList.add('spinning');
                        setTimeout(() => slot.classList.remove('spinning'), 50);
                    });
                    spinCycles++;
                    if (spinCycles >= maxCycles) {
                        clearInterval(spinInterval);
                        displaySlotResult(); // Pass control to result determination
                    }
                }, 80); // Adjust interval for spin speed
            }
    
            function displaySlotResult() {
                if (!slots || slots.length !== 3 || !slotResultMessage) {
                    isSpinning = false; if (spinButton) spinButton.disabled = false; return;
                }
    
                let rand = Math.random() * 100; // Use percentage for easier comparison
                let outcomeType = 'Mixed';
                let resultItems = [];
                let message = "";
    
                // Define probability thresholds (cumulative)
                const prob_Phone = 0.05;         // 0.05%
                const prob_Camera = 0.1;        // 0.1%
                const prob_Fu = 20.0;           // 20%
                const prob_Hearts = 20.0;       // 20%
                const prob_Cakes = 15.0;        // 15%
                const prob_Outing = 5.0;        // 5%
                const prob_Travel = 5.0;        // 5%
                const prob_Service = 5.0;       // 5%
                const prob_Material = 5.0;      // 5%
                const prob_Interaction = 5.0;   // 5%
                // Kiss probability is the remainder: 100 - (sum of above) = 19.85%
    
                let cumulativeProb = 0;
    
                // Determine outcome based on probabilities, checking limits first
                cumulativeProb += prob_Phone;
                if (!phoneWon && rand < cumulativeProb) { outcomeType = '3_Phones'; }
                else {
                    cumulativeProb += prob_Camera;
                    if (!cameraWon && rand < cumulativeProb) { outcomeType = '3_Cameras'; }
                    else {
                        cumulativeProb += prob_Fu;
                        if (slotWinningsTotal < SLOT_WINNINGS_CAP && rand < cumulativeProb) { outcomeType = '3_Fu'; }
                        else {
                            cumulativeProb += prob_Hearts;
                            if (rand < cumulativeProb) { outcomeType = '3_Hearts'; }
                             else {
                                 cumulativeProb += prob_Cakes;
                                 // Allow unlocking even if already unlocked, message changes
                                 if (rand < cumulativeProb) { outcomeType = '3_Cakes'; }
                                else {
                                    cumulativeProb += prob_Outing;
                                    if (!outingPrizeWon && rand < cumulativeProb) { outcomeType = 'Outing_Prize'; }
                                    else {
                                        cumulativeProb += prob_Travel;
                                        if (!travelPrizeWon && rand < cumulativeProb) { outcomeType = 'Travel_Prize'; }
                                        else {
                                            cumulativeProb += prob_Service;
                                            if (!servicePrizeWon && rand < cumulativeProb) { outcomeType = 'Service_Prize'; }
                                            else {
                                                cumulativeProb += prob_Material;
                                                if (!materialPrizeWon && rand < cumulativeProb) { outcomeType = 'Material_Prize'; }
                                                else {
                                                     cumulativeProb += prob_Interaction;
                                                     if (!interactionPrizeWon && rand < cumulativeProb) { outcomeType = 'Interaction_Prize'; }
                                                     else {
                                                          // Remainder is Kiss or forced replacement
                                                          let forceLoveQuote = false;
                                                          if (rand < cumulativeProb) { // Hit a limited prize that was already won
                                                              if (outcomeType === 'Mixed') { // Ensure it wasn't already set to Mixed
                                                                 // Check which category was hit but already won
                                                                 let tempRand = rand;
                                                                 if(tempRand >= (cumulativeProb - prob_Interaction) && interactionPrizeWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material) && materialPrizeWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service) && servicePrizeWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service - prob_Travel) && travelPrizeWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service - prob_Travel - prob_Outing) && outingPrizeWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service - prob_Travel - prob_Outing - prob_Cakes - prob_Hearts) && slotWinningsTotal >= SLOT_WINNINGS_CAP ) forceLoveQuote = true; // Fu cap
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service - prob_Travel - prob_Outing - prob_Cakes - prob_Hearts - prob_Fu - prob_Camera) && cameraWon) forceLoveQuote = true;
                                                                 else if(tempRand >= (cumulativeProb - prob_Interaction - prob_Material - prob_Service - prob_Travel - prob_Outing - prob_Cakes - prob_Hearts - prob_Fu - prob_Camera - prob_Phone) && phoneWon) forceLoveQuote = true;
    
                                                              }
                                                          }
    
                                                          if(forceLoveQuote) {
                                                             console.log("Forcing Love Quote due to win limit.");
                                                             outcomeType = '3_Hearts';
                                                          } else {
                                                             outcomeType = '3_Kisses'; // Default to kiss if nothing else hit
                                                          }
                                                     }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
    
    
                // Handle outcome
                switch (outcomeType) {
                    case '3_Phones':
                        resultItems = ['ğŸ“±', 'ğŸ“±', 'ğŸ“±'];
                        phoneWon = true;
                        let phoneModel = Math.random() < 0.5 ? "çº¢ç±³ K80" : "Oppo Reno 13";
                        message = `å¤©å‘ï¼è¶…çº§å¤§å¥–ï¼ğŸ“±ğŸ“±ğŸ“± èµ¢å¾—ä¸€éƒ¨æ–°æ‰‹æœº (${phoneModel})ï¼`;
                        break;
                    case '3_Cameras':
                        resultItems = ['ğŸ“·', 'ğŸ“·', 'ğŸ“·'];
                        cameraWon = true;
                        message = "éš¾ä»¥ç½®ä¿¡ï¼è¶…çº§å¤§å¥–ï¼ğŸ“·ğŸ“·ğŸ“· èµ¢å¾—ä¸€å°ç´¢å°¼ç›¸æœºï¼";
                        break;
                    case '3_Fu':
                        resultItems = ['ç¦', 'ç¦', 'ç¦'];
                        let winningsToAdd = 10; // Example amount per win
                        let actualWinnings = Math.min(winningsToAdd, SLOT_WINNINGS_CAP - slotWinningsTotal);
                        if (actualWinnings > 0) {
                            slotWinningsTotal += actualWinnings;
                            message = `å¤ªæ£’äº†ï¼ç¦ç¦ç¦ï¼è·å¾— ${actualWinnings} å…ƒå¹¸è¿å¥–é‡‘ï¼ğŸ’° (å½“å‰ç´¯è®¡: ${slotWinningsTotal}å…ƒ)`;
                        } else {
                            // If cap was already reached before this spin, outcome would be 3_Hearts
                            // This case means they hit the cap exactly with this win or were already capped.
                            message = `å¹¸è¿å¥–é‡‘å·²è¾¾ä¸Šé™(${SLOT_WINNINGS_CAP}å…ƒ)ï¼æœ¬æ¬¡è½¬ä¸ºæƒ…è¯â¤ï¸`;
                             outcomeType = '3_Hearts'; // Force outcome change
                             resultItems = ['â¤ï¸', 'â¤ï¸', 'â¤ï¸'];
                             message = `ğŸ’–ğŸ’–ğŸ’– ${getRandomLoveQuote()}`; // Re-set message
                        }
                        break;
                    case '3_Hearts':
                        resultItems = ['â¤ï¸', 'â¤ï¸', 'â¤ï¸'];
                        message = `ğŸ’–ğŸ’–ğŸ’– ${getRandomLoveQuote()}`;
                        break;
                    case '3_Cakes':
                        resultItems = ['ğŸ‚', 'ğŸ‚', 'ğŸ‚'];
                        if (!hongbaoGameUnlocked) {
                            message = "æ­å–œï¼ğŸ‚ğŸ‚ğŸ‚ è§£é”çº¢åŒ…é›¨æ¸¸æˆï¼";
                            hongbaoGameUnlocked = true;
                            if (proceedToHongbaoGameButton) proceedToHongbaoGameButton.style.display = 'inline-block';
                        } else {
                            message = "çº¢åŒ…é›¨æ¸¸æˆå·²è§£é”ï¼å¯ä»¥ç»§ç»­æŠ½å¥–æˆ–å¼€å§‹æ¸¸æˆã€‚";
                        }
                        break;
                     case 'Outing_Prize':
                         resultItems = ['ğŸ¡','ğŸ¡','ğŸ¡'];
                         outingPrizeWon = true;
                         wonOutingItem = getRandomItem(outingItems);
                         message = `æ­å–œï¼ğŸ¡ğŸ¡ğŸ¡ èµ¢å¾—ç‰¹æ®Šå¥–åŠ±: ${wonOutingItem}ï¼`;
                         break;
                     case 'Travel_Prize':
                         resultItems = ['âœˆï¸','âœˆï¸','âœˆï¸'];
                         travelPrizeWon = true;
                         wonTravelItem = getRandomItem(travelItems);
                         message = `æ­å–œï¼âœˆï¸âœˆï¸âœˆï¸ èµ¢å¾—ç‰¹æ®Šå¥–åŠ±: ${wonTravelItem}ï¼`;
                         break;
                     case 'Service_Prize':
                         resultItems = ['ğŸ’–','ğŸ’–','ğŸ’–'];
                         servicePrizeWon = true;
                         wonServiceItem = getRandomItem(serviceItems);
                         message = `æ­å–œï¼ğŸ’–ğŸ’–ğŸ’– èµ¢å¾—ç‰¹æ®Šå¥–åŠ±: ${wonServiceItem}ï¼`;
                         break;
                     case 'Material_Prize':
                         resultItems = ['ğŸ’°','ğŸ’°','ğŸ’°'];
                         materialPrizeWon = true;
                         wonMaterialItem = getRandomItem(materialItems);
                         message = `æ­å–œï¼ğŸ’°ğŸ’°ğŸ’° èµ¢å¾—ç‰¹æ®Šå¥–åŠ±: ${wonMaterialItem}ï¼`;
                         break;
                     case 'Interaction_Prize':
                         resultItems = ['ğŸŸï¸','ğŸŸï¸','ğŸŸï¸'];
                         interactionPrizeWon = true;
                         wonInteractionItem = getRandomItem(interactionItems);
                         message = `æ­å–œï¼ğŸŸï¸ğŸŸï¸ğŸŸï¸ èµ¢å¾—ç‰¹æ®Šå¥–åŠ±: ${wonInteractionItem}ï¼`;
                         break;
                    case '3_Kisses':
                        resultItems = ['ğŸ’‹', 'ğŸ’‹', 'ğŸ’‹'];
                        message = "é€å§å§ä¸€ä¸ªæ¥è‡ªå°‘çˆ·çš„é£å»~ ğŸ’‹";
                        break;
                    case 'Mixed':
                    default: // Also handles cases where a limited prize was hit but already won (logic defaults to Mixed here)
                        // Ensure the generated mixed result is not actually a winning combo that was skipped due to limits
                        do {
                           resultItems = [
                               slotItems[Math.floor(Math.random() * slotItems.length)],
                               slotItems[Math.floor(Math.random() * slotItems.length)],
                               slotItems[Math.floor(Math.random() * slotItems.length)]
                           ];
                         } while (
                             (resultItems[0] === resultItems[1] && resultItems[1] === resultItems[2]) // Avoid natural triples
                         );
                        message = "å“å‘€ï¼Œå·®ä¸€ç‚¹ç‚¹ï¼å†æ¥ä¸€æ¬¡å§ï¼";
                        break;
                }
    
                slots.forEach((slot, index) => { slot.textContent = resultItems[index]; });
                slotResultMessage.textContent = message;
    
                isSpinning = false;
                if (spinButton) spinButton.disabled = false;
                // Update prize dialog immediately if it's visible
                 if (prizeDialogView && prizeDialogView.classList.contains('visible')) {
                     showPrizeDialog();
                 }
            }
    
    
            // --- Falling Items Game Logic (BIRTHDAY HONGBAO - Unaffected by Slot Limits) ---
            function startGame() {
                console.log("Starting falling game (Birthday Hongbao)...");
                if (!gameArea || !scoreDisplay || !timerDisplay || !gameResultDisplay || !roundDisplay || !gameInfo) { console.error("Critical game elements not found at startGame!"); return; }
    
                currentRound++; console.log(`Starting Round ${currentRound}`); if (currentRound > maxRounds) { console.log("Max rounds reached, showing final result."); showFinalResult(); return; }
                stopGame(); // Stop previous round processes
                itemsSpawnedThisRound = 0; hongbaoSpawnedThisRound = 0; miceSpawnedThisRound = 0; greenSpawnedThisRound = 0; timeLeft = 30; gameActive = true;
                try { if(roundDisplay) roundDisplay.textContent = `ç¬¬ ${currentRound} / ${maxRounds} å±€`; if(scoreDisplay) scoreDisplay.textContent = `å½“å‰ç”Ÿæ—¥çº¢åŒ… ${totalScore} å…ƒ`; /* Updated Text */ if(timerDisplay) timerDisplay.textContent = timeLeft; if(gameResultDisplay) gameResultDisplay.style.display = 'none'; if(gameArea) gameArea.style.display = 'block'; if(gameInfo) gameInfo.style.display = 'block'; } catch(e) { console.error("Error resetting display:", e); }
                try { if (gameTimerInterval) clearInterval(gameTimerInterval); gameTimerInterval = setInterval(() => { if (!gameActive) { clearInterval(gameTimerInterval); return; } timeLeft--; if (timerDisplay) timerDisplay.textContent = timeLeft; if (timeLeft <= 0) { gameOver(); } }, 1000); } catch(e) { console.error("Error starting timer:", e); gameActive = false; return; }
                try { if (itemSpawnInterval) clearInterval(itemSpawnInterval); itemSpawnInterval = setInterval(spawnRandomItem, ITEM_SPAWN_INTERVAL); } catch(e) { console.error("Error starting item spawn:", e); stopGame(); return; }
                try { if (gameArea) gameArea.removeEventListener('click', handleGameAreaClick); if (gameArea) gameArea.addEventListener('click', handleGameAreaClick); } catch(e) { console.error("Error adding click listener:", e); stopGame(); return; }
                console.log(`Round ${currentRound} started successfully.`);
            }
    
            function stopGame() { console.log("Stopping falling game elements..."); gameActive = false; try { clearInterval(gameTimerInterval); clearInterval(itemSpawnInterval); } catch(e) { console.error("Error clearing intervals:", e); } gameTimerInterval = null; itemSpawnInterval = null; try { if(gameArea) { gameArea.removeEventListener('click', handleGameAreaClick); const remainingItems = gameArea.querySelectorAll('.game-item'); remainingItems.forEach(item => { const tid = item.dataset.removalTimeoutId; if(tid) clearTimeout(parseInt(tid)); item.remove(); }); } } catch(e) { console.error("Error cleaning up game area:", e); } console.log("Falling game elements stopped."); }
            function spawnRandomItem() { if (!gameArea || !gameActive || itemsSpawnedThisRound >= maxItemsPerRound) { if (itemsSpawnedThisRound >= maxItemsPerRound) { console.log(`Max total items (${maxItemsPerRound}) reached for round ${currentRound}.`); } return; } const rand = Math.random(); let itemType = null; let canSpawn = false; if (rand < 0.333) { itemType = 'hongbao'; } else if (rand < 0.666) { itemType = 'mouse'; } else { itemType = 'green'; } switch (itemType) { case 'hongbao': if (hongbaoSpawnedThisRound < maxHongbaoPerRound) { canSpawn = true; hongbaoSpawnedThisRound++; } break; case 'mouse': if (miceSpawnedThisRound < maxMicePerRound) { canSpawn = true; miceSpawnedThisRound++; } break; case 'green': if (greenSpawnedThisRound < maxGreenPerRound) { canSpawn = true; greenSpawnedThisRound++; } break; } if (canSpawn && itemType) { itemsSpawnedThisRound++; switch (itemType) { case 'hongbao': createHongbao(); break; case 'mouse': createMouse(); break; case 'green': createGreenEnvelope(); break; } } else if (!canSpawn && itemType) { } }
            function createGameItem(className, content) { if (!gameArea || !gameActive) return; try { const item = document.createElement('div'); item.classList.add('game-item', className); if (content) item.innerHTML = content; const gameAreaWidth = gameArea.offsetWidth; const itemWidth = 50; item.style.left = Math.max(0, Math.random() * (gameAreaWidth - itemWidth)) + 'px'; const durationVariation = Math.random() * 1000 - 500; const actualDuration = Math.max(3000, ITEM_FALL_DURATION + durationVariation); item.style.animationDuration = actualDuration / 1000 + 's'; gameArea.appendChild(item); const removalTimeout = setTimeout(() => { if (item.parentNode) { item.remove(); } }, actualDuration + 200); item.dataset.removalTimeoutId = removalTimeout; } catch(e) { console.error(`Error creating ${className}:`, e); } }
            function createHongbao() { createGameItem('hongbao'); } function createGreenEnvelope() { createGameItem('green-envelope'); } function createMouse() { createGameItem('mouse-item'); }
            function handleGameAreaClick(event) { if (!gameActive || !event.target) return; const clickedItem = event.target.closest('.game-item'); if (!clickedItem) return; try { let scoreChange = 0; if (clickedItem.classList.contains('hongbao')) { scoreChange = 1; } else if (clickedItem.classList.contains('green-envelope')) { scoreChange = -1; } else if (clickedItem.classList.contains('mouse-item')) { scoreChange = -3; } if (scoreChange !== 0) { totalScore += scoreChange; // Only update Birthday Hongbao total
                if (scoreDisplay) scoreDisplay.textContent = `å½“å‰ç”Ÿæ—¥çº¢åŒ… ${totalScore} å…ƒ`; /* Update display on click */ } const removalTimeoutId = clickedItem.dataset.removalTimeoutId; if (removalTimeoutId) { clearTimeout(parseInt(removalTimeoutId)); } clickedItem.remove(); } catch(e) { console.error("Error handling game item click:", e); } }
            function gameOver() { console.log(`Falling Game Round ${currentRound} Over. Birthday Score: ${totalScore}`); stopGame(); if (currentRound >= maxRounds) { showFinalResult(); } else { showEndOfRoundOptions(); } }
            function showEndOfRoundOptions() { if (!gameResultDisplay || !gameResultText || !gameResultButtons || !gameArea || !gameInfo) return; console.log("Showing end of round options."); if (gameArea) gameArea.style.display = 'none'; if (gameInfo) gameInfo.style.display = 'none'; gameResultText.textContent = `ç¬¬ ${currentRound} å±€ç»“æŸï¼å½“å‰ç”Ÿæ—¥çº¢åŒ…ï¼š${totalScore} å…ƒ`; gameResultButtons.style.display = 'flex'; gameResultDisplay.style.display = 'block'; }
    
            function showFinalResult() {
                if (!gameResultDisplay || !gameResultText || !gameResultButtons) return;
                console.log("Showing final combined result.");
                stopGame(); // Ensure birthday game is stopped
    
                // Ensure only the result view is visible within the game overlay
                hideAllViews(); // Hide other main views first
                if (gameView) gameView.style.display = 'flex'; // Show the game overlay container
                if (gameArea) gameArea.style.display = 'none'; // Hide game area
                if (gameInfo) gameInfo.style.display = 'none'; // Hide round info
    
                let combinedTotal = totalScore + slotWinningsTotal; // Combine scores for final display
                gameResultText.innerHTML = `æ¸¸æˆç»“æŸï¼<br>ç”Ÿæ—¥çº¢åŒ…å¾—åˆ† ${totalScore} å…ƒ + å¹¸è¿å¥–é‡‘ ${slotWinningsTotal} å…ƒ = <br>æ€»è®¡ <span class="prize-code">${combinedTotal}</span> å…ƒï¼<br>è¯·æˆªå›¾æ‰¾å“¥å“¥å…‘æ¢å¥–åŠ±ï¼`;
                gameResultButtons.style.display = 'none'; // Hide continue/redeem buttons
                gameResultDisplay.style.display = 'block'; // Show final result box
                window.scrollTo(0, 0);
            }
    
            // --- Event Listeners ---
            if (cakeLink) { if (typeof showLoveLetter === 'function' && typeof tryPlayBackgroundAudio === 'function') { cakeLink.addEventListener('click', (event) => { try { event.preventDefault(); if (isDragAction) { console.log("Cake click ignored due to drag action."); return; } console.log("Cake clicked, attempting to show love letter..."); if (loveWarningMessage) { loveWarningMessage.style.display = 'block'; setTimeout(() => { if (loveWarningMessage) loveWarningMessage.style.display = 'none'; showLoveLetter(); tryPlayBackgroundAudio(); }, 2500); } else { showLoveLetter(); tryPlayBackgroundAudio(); } } catch(err) { console.error("Error in cake click listener:", err); } }); } else { console.error("showLoveLetter or tryPlayBackgroundAudio function not defined when setting cake listener."); } } else { console.error("Birthday cake link element (#birthday-cake-link) not found!"); }
            if (backButton) { backButton.addEventListener('click', showBirthday); }
            if (gotoGameButton) { gotoGameButton.addEventListener('click', showSlotMachine); } // Resets state and shows slot machine
            if (spinButton) { spinButton.addEventListener('click', spinSlots); }
            if (proceedToHongbaoGameButton) { proceedToHongbaoGameButton.addEventListener('click', showPasswordPrompt); } // Leads to birthday game
            if (backFromSlotMachineButton) { backFromSlotMachineButton.addEventListener('click', showLoveLetter); }
            if (confirmStartGameButton) { confirmStartGameButton.addEventListener('click', showGame); } // Starts birthday game
            if (backFromGameButton) { backFromGameButton.addEventListener('click', showLoveLetter); } // Back from birthday game
            if (continueGameButton) { continueGameButton.addEventListener('click', showGame); } // Next round of birthday game
            if (redeemEarlyButton) { redeemEarlyButton.addEventListener('click', showFinalResult); } // End birthday game early
    
             // Updated: Event listeners for new prize dialog
             if (showSlotWinningsButtons.length > 0) {
                 showSlotWinningsButtons.forEach(button => {
                     button.addEventListener('click', showPrizeDialog);
                 });
             } else {
                 console.log("Show winnings buttons not found.");
             }
             if (closePrizeDialogButton) {
                 closePrizeDialogButton.addEventListener('click', hidePrizeDialog);
             } else {
                 console.log("Close prize dialog button not found.");
             }
    
    
            // --- Initial Setup ---
            try {
                 // Initialize variables on first load
                 totalScore = 0; currentRound = 0; slotWinningsTotal = 0;
                 hongbaoGameUnlocked = false; lastActiveViewId = 'birthday-view';
                 phoneWon = false; cameraWon = false;
                 outingPrizeWon = false; wonOutingItem = null;
                 travelPrizeWon = false; wonTravelItem = null;
                 servicePrizeWon = false; wonServiceItem = null;
                 materialPrizeWon = false; wonMaterialItem = null;
                 interactionPrizeWon = false; wonInteractionItem = null;
                 isSpinning = false;
    
                 hideAllViews(); // Initial hide
                 if (birthdayView) {
                     birthdayView.style.display = 'block'; // Show initial view
                     lastActiveViewId = 'birthday-view'; // Set initial last view
                     birthdayIntervalId = startFallingItems(birthdayIntervalId, birthdayItems, birthdayView, BIRTHDAY_INTERVAL_TIME);
                 } else { console.error("Birthday view not found!"); }
    
                 // Setup Audio Player
                  if (audioElement && playPauseButton && seekBar && currentTimeDisplay && durationDisplay && playIcon) {
                      if (!isNaN(audioElement.duration) && audioElement.duration > 0) {
                          seekBar.max = audioElement.duration; durationDisplay.textContent = formatTime(audioElement.duration); currentTimeDisplay.textContent = formatTime(0);
                      } else {
                          audioElement.onloadedmetadata = () => {
                              if (!isNaN(audioElement.duration)) { seekBar.max = audioElement.duration; durationDisplay.textContent = formatTime(audioElement.duration); }
                              else { seekBar.max = 100; durationDisplay.textContent = "0:00"; }
                          };
                          seekBar.max = 100; durationDisplay.textContent = "0:00"; currentTimeDisplay.textContent = "0:00";
                      }
                      updatePlayPauseIcon();
                  } else { if (audioPlayerContainer) audioPlayerContainer.style.display = 'none'; console.error("Audio player elements missing."); }
    
                  // Setup Slideshow
                  if (slideshow && slideCount > 0 && dotsContainer && prevButton && nextButton && slideshowCaption) {
                       createDots(); showSlide(0); startSlideshowAutoplay();
                  } else { if (slideshowContainer) slideshowContainer.style.display = 'none'; console.error("Slideshow elements missing."); }
    
                 console.log("Initial setup complete.");
             } catch (error) {
                 console.error("Error during initial setup:", error);
             }
    
        }); // End of DOMContentLoaded listener
     </script>
 </body>
 </html>