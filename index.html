<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>张珊珊的生日快乐！</title>
    <style>
        /* --- General Styles --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6; margin: 0; padding-bottom: 80px; /* Adjust padding if needed */
            background-color: #f8f0f8; /* Fallback */
            overflow-x: hidden; font-size: 16px; min-height: 100vh; position: relative;
            -webkit-overflow-scrolling: touch;
        }
        body, div, p, h1, button { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* --- Background Layers --- */
        #background-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background-image: url("background.jpg"); /* <<< 替换这里! */ background-size: cover; background-position: center center; }
        #background-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-color: rgba(255, 192, 203, 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        /* --- Views --- */
        #birthday-view, #love-letter-view { padding: 15px; position: relative; z-index: 1; }
        #birthday-view { background-color: rgba(248, 240, 248, 0.75); cursor: url('heart.png'), auto; display: block; min-height: 100vh; }
        #love-letter-view { display: none; font-family: 'KaiTi', 'STKaiti', 'SimSun', serif; background-color: rgba(255, 250, 240, 0.88); color: #5a463a; max-width: 95%; margin: 40px auto; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); border-radius: 8px; padding: 20px; padding-top: 60px; padding-bottom: 80px; position: relative; z-index: 10; }
        #love-letter-view::before { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 0; border-style: solid; border-width: 60px 0 0 calc(50vw - 15px); border-color: rgba(254, 202, 202, 0.8) transparent transparent rgba(254, 202, 202, 0.8); z-index: 1; border-top-left-radius: 8px; }
        #love-letter-view::after { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 0; border-style: solid; border-width: 0 0 60px calc(50vw - 15px); border-color: transparent rgba(254, 202, 202, 0.8) rgba(254, 202, 202, 0.8) transparent; z-index: 1; border-top-right-radius: 8px; }

        /* --- Birthday View Content Styles [Existing - Minimized] --- */
        #birthday-view .birthday-container { z-index: 10; display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: 30px; position: relative; padding: 0 30px;}
        #birthday-view #birthday-cake-link { display: flex; justify-content: center; width: 100%; text-decoration: none; cursor: inherit; position: relative; -webkit-tap-highlight-color: transparent; }
        #birthday-view #birthday-cake { display: block; max-width: 100%; max-height: 280px; height: auto; width: auto; object-fit: contain; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
        #birthday-view #birthday-cake-link:hover #birthday-cake { transform: scale(1.05); }
        #birthday-view #birthday-message { font-size: 1.6em; font-weight: bold; color: #e83e8c; text-shadow: 1px 1px 2px #fff; margin-top: 0; padding: 0 10px; margin-bottom: 30px; position: relative; z-index: 10; }
        #birthday-view h1 { font-size: 1.8em; color: #6f42c1; text-align: center; position: relative; z-index: 10; margin-bottom: 15px; }
        #birthday-view hr { position: relative; z-index: 10; margin-top: 30px; border: 0; height: 1px; background: #ccc; }
        #birthday-view .footer-text { text-align: center; color: #555; position: relative; z-index: 10; padding-bottom: 20px; font-size: 0.9em; }

        /* --- Love Letter View Styles [Existing - Minimized] --- */
        #love-letter-view h1 { font-size: 1.6em; color: #d9534f; text-align: center; margin-bottom: 25px; font-family: sans-serif; position: relative; padding: 0 30px; z-index: 2; }
        #love-letter-view h1::before { content: '🎂'; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); font-size: 0.9em; z-index: 3;}
        #love-letter-view h1::after { content: '❤️'; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.9em; z-index: 3;}
        #love-letter-view p { margin-bottom: 1.3em; text-indent: 2em; font-size: 1em; position: relative; z-index: 2; }
        #love-letter-view .signature { text-align: right; margin-top: 30px; font-style: italic; line-height: 1.6; font-size: 0.95em; position: relative; z-index: 2; }
        #love-letter-view .back-button { display: block; text-align: center; margin: 30px auto 0 auto; padding: 12px 25px; background-color: #6f42c1; color: white; text-decoration: none; border-radius: 8px; font-family: sans-serif; cursor: pointer; border: none; font-size: 1.1em; width: fit-content; position: relative; z-index: 10; -webkit-tap-highlight-color: transparent; }
        #love-letter-view .back-button:hover { background-color: #5a349a; }

        /* --- Falling Items Styles [Existing] --- */
        .falling-item { position: absolute; top: -60px; font-size: 22px; user-select: none; pointer-events: none; animation: fall linear forwards; opacity: 0.75; z-index: 5; will-change: transform, opacity; }
        @keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 0.75; } 100% { transform: translateY(calc(100vh + 100px)) rotate(calc(var(--random-rotate, 0) * 1deg)); opacity: 0; } }

        /* --- Pointer Trail Heart Styles [Existing] --- */
        .pointer-heart { position: fixed; font-size: 20px; color: #ff4d6d; pointer-events: none; user-select: none; z-index: 9999; animation: fade-move-out 0.8s ease-out forwards; text-shadow: 0 0 5px rgba(0, 0, 0, 0.3); }
        @keyframes fade-move-out { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -150%) scale(0.5); } }

        /* --- Slideshow Styles [Existing - Minimized] --- */
        #photo-slideshow-container { position: relative; z-index: 10; max-width: 500px; margin: 20px auto; padding: 20px; background-color: rgba(255, 240, 245, 0.85); border-radius: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border: 10px solid transparent; border-image: linear-gradient(45deg, #ffc2d1, #ff8fab, #fecaca) 1; }
        #slideshow-wrapper { position: relative; overflow: hidden; border-radius: 15px; aspect-ratio: 4 / 3; background-color: #eee; }
        #slideshow { display: flex; width: 100%; height: 100%; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .slide img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .slideshow-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255, 194, 209, 0.7); border: none; color: #fff; font-size: 1.5em; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 15; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); -webkit-tap-highlight-color: transparent; }
        .slideshow-nav:hover { background-color: rgba(255, 127, 171, 0.9); }
        .slideshow-nav.prev { left: -15px; }
        .slideshow-nav.next { right: -15px; }
        .dots-container { text-align: center; margin-top: 10px; position: relative; z-index: 15; }
        .dot { display: inline-block; width: 10px; height: 10px; background-color: #ffc2d1; border-radius: 50%; margin: 0 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .dot.active { background-color: #ff75ac; }

        /* --- Click Arrow Styles [Existing] --- */
        .click-arrow { width: 0; height: 0; border-style: solid; position: absolute; z-index: 11; pointer-events: none; animation: bounce-arrow 1.5s infinite ease-in-out; opacity: 0.8; }
        .arrow-tr { border-width: 15px 15px 0 0; border-color: #ff75ac transparent transparent transparent; top: 10px; left: 10px; transform: rotate(135deg); animation-delay: 0s; }
        .arrow-tl { border-width: 15px 15px 0 0; border-color: #ff75ac transparent transparent transparent; top: 10px; right: 10px; transform: rotate(225deg); animation-delay: 0.5s; }
        .arrow-br { border-width: 15px 15px 0 0; border-color: #ff75ac transparent transparent transparent; bottom: 10px; left: 10px; transform: rotate(45deg); animation-delay: 1s; }
        @keyframes bounce-arrow { 0%, 100% { transform: translateY(0) rotate(var(--rotate-angle)); opacity: 0.8; } 50% { transform: translateY(-8px) rotate(var(--rotate-angle)); opacity: 0.6; } }
        .arrow-tr { --rotate-angle: 135deg; }
        .arrow-tl { --rotate-angle: 225deg; }
        .arrow-br { --rotate-angle: 45deg; }

        /* --- Custom Audio Player Styles (Smaller & Frosted Glass) --- */
        #audio-player-container {
            position: fixed; bottom: 10px; right: 10px; left: auto; transform: none;
            width: 85%; /* Slightly smaller width */
            max-width: 320px; /* Reduced max-width */
            z-index: 10000;
            /* Adjusted Pink Frosted Glass Effect */
            background: rgba(255, 222, 233, 0.7); /* Base pink tint, more transparent */
            backdrop-filter: blur(6px); /* Increased blur slightly */
            -webkit-backdrop-filter: blur(6px);
            border-radius: 10px; /* Slightly smaller radius */
            padding: 8px 12px; /* Reduced padding */
            box-shadow: 0 -1px 8px rgba(0,0,0,0.1); /* Softer shadow */
            display: flex; align-items: center;
            gap: 8px; /* Reduced gap */
            cursor: move; touch-action: none;
        }
        #play-pause-button {
            background-color: #ff75ac; border: none; color: white;
            font-size: 1.3em; /* Smaller icon */
            border-radius: 50%;
            width: 40px; /* Smaller button */
            height: 40px; /* Smaller button */
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease; flex-shrink: 0; padding: 0; line-height: 1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
             -webkit-tap-highlight-color: transparent;
        }
        #play-pause-button:hover { background-color: #ff5c9a; }
        #play-pause-button .play-icon::before { content: '▶️'; }
        #play-pause-button .pause-icon::before { content: '⏸️'; }
        .audio-controls-right { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        #seek-bar {
            width: 100%; height: 6px; /* Thinner bar */
            cursor: pointer; appearance: none; background: #ffc2d1; border-radius: 3px; outline: none;
        }
        #seek-bar::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; /* Smaller thumb */ background: #ff75ac; border-radius: 50%; cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        #seek-bar::-moz-range-thumb { width: 14px; height: 14px; background: #ff75ac; border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        .time-display {
            display: flex; justify-content: space-between;
            font-size: 0.75em; /* Smaller time text */
            color: #8c5f6f; margin-top: 3px; padding: 0 2px;
        }
        #audio-element { display: none; }

        /* Media Query Adjustments [Existing - Minimized] */
        @media (max-width: 600px) { #photo-slideshow-container { max-width: 95%; padding: 10px; border-width: 8px; } .slideshow-nav { width: 35px; height: 35px; font-size: 1.3em; } .slideshow-nav.prev { left: -10px; } .slideshow-nav.next { right: -10px; } .dot { width: 8px; height: 8px; margin: 0 4px;} /* Player already smaller, may not need specific mobile override now */ /*#audio-player-container { max-width: 300px; }*/ #love-letter-view::before { border-width: 45px 0 0 calc(50vw - 10px); } #love-letter-view::after { border-width: 0 0 45px calc(50vw - 10px); } #love-letter-view { padding-top: 45px; margin-top: 30px;} .click-arrow { border-width: 10px 10px 0 0; } .arrow-tr { top: 5px; left: 5px;} .arrow-tl { top: 5px; right: 5px;} .arrow-br { bottom: 5px; left: 5px;} }
        @media (max-width: 360px) { #birthday-view h1, #love-letter-view h1 { font-size: 1.5em; } #love-letter-view h1 { padding: 0 25px; } #love-letter-view h1::before, #love-letter-view h1::after { font-size: 0.8em; } #birthday-view #birthday-message { font-size: 1.4em; } #love-letter-view p { font-size: 0.95em; } .falling-item { font-size: 20px; } .pointer-heart { font-size: 18px; } #audio-player-container { width: 95%; gap: 5px; padding: 5px 8px; } #play-pause-button { width: 35px; height: 35px; font-size: 1.1em; } .time-display { font-size: 0.7em; } #seek-bar::-webkit-slider-thumb { width: 12px; height: 12px; } #seek-bar::-moz-range-thumb { width: 12px; height: 12px; } }

    </style>
</head>
<body>

    <div id="background-layer"></div>
    <div id="background-overlay"></div>

    <div id="birthday-view"><h1>✨ 生日快乐 ✨</h1><div class="birthday-container"><a id="birthday-cake-link" href="#"><div class="click-arrow arrow-tr"></div><div class="click-arrow arrow-tl"></div><div class="click-arrow arrow-br"></div><img id="birthday-cake" src="cake-placeholder.jpg" alt="生日蛋糕 (点击有惊喜)"></a><p id="birthday-message">张珊珊女士 21岁 生日快乐! 🎂🎉</p><p class="footer-text">祝你拥有美好的一天！ (点击蛋糕有惊喜哦!)</p></div><div id="photo-slideshow-container"><div id="slideshow-wrapper"><div id="slideshow"><div class="slide"><img src="placeholder1.jpg" alt="珊珊的照片 1"></div><div class="slide"><img src="placeholder2.jpg" alt="珊珊的照片 2"></div><div class="slide"><img src="placeholder3.jpg" alt="珊珊的照片 3"></div></div></div><button class="slideshow-nav prev" aria-label="上一张">🎂</button><button class="slideshow-nav next" aria-label="下一张">🎂</button><div class="dots-container"></div></div><hr><p class="footer-text">祝你变有钱。</p></div>
    <div id="love-letter-view"><h1>致 我独一无二的、最特别的珊珊 ❤️</h1><p>提笔想给你写点什么，尤其是在你生日将近的日子，心情有点像那次和你线下见面时——既期待又紧张，还带着点我们之间特有的“癫”。快一年了，时间好像过得飞快，又好像每一天的聊天都值得被细细回味。</p><p>还记得吗？从最初那个叫我“小屁孩”怼得我差点拉黑你的“张三”（当然是玩笑，我哪里舍得），到后来那个会发搞怪表情包、会在语音里偷笑的“皇后娘娘”，再到那个嘴上说着“不谈恋爱”、“我就是渣女”，却会因为担心我而退回红包、会因为我需要而用花呗买鼠标、会在我“发癫”后依然主动问早的“傻姑娘”……你身上这种矛盾又真实的可爱，就像拆盲盒，总能给我意想不到的惊喜。</p><p>以前总觉得世事纷扰，人心复杂难测，直到遇见你，才明白那句“众里寻他千百度，蓦然回首，那人却在，灯火阑珊处”或许是真的。 你的出现，像一道光，照亮了我之前可能有些灰暗和充满“精神内耗”的世界。是你用你的“癫”、你的善良、你的原则，还有你那面对生活不易时的韧性，让我觉得这个世界原来还可以这么有趣和值得期待。和你聊天成了我每天雷打不动的习惯和最大的乐趣，你分享的日常琐碎，在我这里都变成了值得珍藏的风景。</p><p>我知道，我们之间这种“羁绊”很特别，深到有时连我们自己都难以简单定义。没关系，“身无彩凤双飞翼，心有灵犀一点通”，很多时候，我觉得你懂我内心那些未说出口的焦虑和期盼，我也在努力去理解你那句“慢慢来吧”背后可能隐藏的顾虑和需要。感谢你愿意向我敞开那么多，信任我这么多。</p><p>我也知道，你心里可能装着对过去的担忧，对未来的不确定，对“关系”本身的恐惧。我不会再像以前那样，急切地逼你给一个答案，也不会再开那些不合时宜的玩笑了（如果我又“癫”了，记得用表情包提醒我哦）。你的生日，我最大的、也是唯一的心愿，就是你能真正地、毫无负担地开心。你想怎么过，我都支持。</p><p>这封信，不是为了在生日这天给你压力，真的。它就是一份迟来的感谢信——感谢缘分让我们相遇，感谢你陪我度过这么多时光，分享这么多欢笑和 emo 的瞬间。它也是一份心意书——告诉你，在我心里，你有多么重要和独一无二。</p><p>至于未来，我们继续“走一步看一步”吧。“人生到处知何似，应似飞鸿踏雪泥。” 未来不可预知，但重要的是，我希望能继续陪在你身边，和你一起面对路上的风景，无论是晴是雨。愿如此缘，能续经年。</p><p>生日快乐，我最珍视的珊珊。</p><div class="signature">那个越来越懂得珍惜你的“癫公”，哥哥或者少爷，<br>章啸宇</div><button class="back-button">返回生日主页面</button></div>
    <div id="audio-player-container"><audio id="audio-element" loop><source src="M5000044Nr9A4ZiFFQ.mp3" type="audio/mpeg">你的浏览器不支持播放音频。</audio><button id="play-pause-button" aria-label="播放/暂停"><span class="play-icon"></span></button><div class="audio-controls-right"><input type="range" id="seek-bar" value="0" aria-label="进度条"><div class="time-display"><span id="current-time">0:00</span><span id="duration">0:00</span></div></div></div>


    <script>
        // --- Existing Variables and Setup ---
        const birthdayView = document.getElementById('birthday-view');
        const loveLetterView = document.getElementById('love-letter-view');
        const cakeLink = document.getElementById('birthday-cake-link');
        const backButton = loveLetterView.querySelector('.back-button');
        const audioElement = document.getElementById('audio-element');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const playPauseButton = document.getElementById('play-pause-button');
        const playIcon = playPauseButton ? playPauseButton.querySelector('.play-icon') : null; // Added null check
        const seekBar = document.getElementById('seek-bar');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        let birthdayIntervalId = null;
        let loveLetterIntervalId = null;
        const birthdayItems = ['🎂', '🌸'];
        const loveLetterItems = ['❤️', '🎂'];
        const BIRTHDAY_INTERVAL_TIME = 550;
        const LOVE_LETTER_INTERVAL_TIME = 500;
        const slideshow = document.getElementById('slideshow');
        const slides = document.querySelectorAll('.slide');
        const prevButton = document.querySelector('.slideshow-nav.prev');
        const nextButton = document.querySelector('.slideshow-nav.next');
        const dotsContainer = document.querySelector('.dots-container');
        let currentSlideIndex = 0;
        let slideInterval = null;
        const slideCount = slides.length;
        const SLIDESHOW_INTERVAL_TIME = 5000;

        // --- Falling Items Functions [Existing] ---
        function createFallingItem(itemType, container) { if (!container || container.style.display === 'none') return; const item = document.createElement('div'); item.classList.add('falling-item'); item.style.left = Math.random() * 95 + 'vw'; item.innerText = itemType; item.style.fontSize = (Math.random() * 10 + 18) + 'px'; const fallDuration = Math.random() * 5 + 7; const delay = Math.random() * 4; item.style.setProperty('--random-rotate', (Math.random() * 80 - 40) || 0); item.style.animationDuration = `${fallDuration}s`; item.style.animationDelay = delay + 's'; container.appendChild(item); setTimeout(() => { if (item && item.parentNode) item.remove(); }, (fallDuration + delay) * 1000 + 500); }
        function startFallingItems(intervalId, itemArray, container, intervalTime) { if (intervalId) clearInterval(intervalId); if (!container) return null; const newIntervalId = setInterval(() => { if (container.style.display !== 'none') { const randomItem = itemArray[Math.floor(Math.random() * itemArray.length)]; createFallingItem(randomItem, container); } }, intervalTime); return newIntervalId; }
        function stopFallingItems(intervalId, container) { if (intervalId) clearInterval(intervalId); if (container) { const existingItems = container.querySelectorAll('.falling-item'); existingItems.forEach(item => item.remove()); } return null; }

        // --- View Switching Logic [Existing] ---
        if (cakeLink) { cakeLink.addEventListener('click', (event) => { event.preventDefault(); showLoveLetter(); }); }
        if (backButton) { backButton.addEventListener('click', showBirthday); }
        function showLoveLetter() { birthdayIntervalId = stopFallingItems(birthdayIntervalId, birthdayView); if(birthdayView) birthdayView.style.display = 'none'; if(loveLetterView) loveLetterView.style.display = 'block'; loveLetterIntervalId = startFallingItems(loveLetterIntervalId, loveLetterItems, loveLetterView, LOVE_LETTER_INTERVAL_TIME); window.scrollTo(0, 0); tryResumeAudio(); stopSlideshowAutoplay(); }
        function showBirthday() { loveLetterIntervalId = stopFallingItems(loveLetterIntervalId, loveLetterView); if(loveLetterView) loveLetterView.style.display = 'none'; if(birthdayView) birthdayView.style.display = 'block'; birthdayIntervalId = startFallingItems(birthdayIntervalId, birthdayItems, birthdayView, BIRTHDAY_INTERVAL_TIME); window.scrollTo(0, 0); tryResumeAudio(); startSlideshowAutoplay(); }

        // --- Pointer Trail Heart Logic (Optimized Throttle) ---
        function throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); } } }
        function createPointerHeart(x, y) { const heart = document.createElement('div'); heart.classList.add('pointer-heart'); heart.innerHTML = '❤️'; heart.style.left = `${x}px`; heart.style.top = `${y}px`; document.body.appendChild(heart); setTimeout(() => { if (heart && heart.parentNode) heart.remove(); }, 800); }
        const throttledCreateHeart = throttle(createPointerHeart, 100); // Increased throttle
        document.body.addEventListener('mousemove', (event) => { throttledCreateHeart(event.pageX, event.pageY); });
        document.body.addEventListener('touchmove', (event) => { if (event.touches.length > 0) { const touch = event.touches[0]; throttledCreateHeart(touch.pageX, touch.pageY); } }, { passive: true });
        document.body.addEventListener('touchstart', (event) => { if (event.touches.length > 0) { const touch = event.touches[0]; throttledCreateHeart(touch.pageX, touch.pageY); } }, { passive: true });

        // --- Custom Audio Player Logic (Added Null Checks) ---
        let isSeeking = false;
        function formatTime(seconds) { const minutes = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${minutes}:${secs < 10 ? '0' : ''}${secs}`; }
        function updatePlayPauseIcon() {
            if (!playIcon || !audioElement || !playPauseButton) return; // Add checks
            playIcon.classList.remove('play-icon', 'pause-icon');
            if (audioElement.paused || audioElement.ended) {
                playIcon.classList.add('play-icon');
                playPauseButton.setAttribute('aria-label', '播放');
            } else {
                playIcon.classList.add('pause-icon');
                playPauseButton.setAttribute('aria-label', '暂停');
            }
        }
        if (playPauseButton && audioElement) { // Check before adding listener
            playPauseButton.addEventListener('click', () => {
                if (audioElement.paused || audioElement.ended) {
                    audioElement.play().catch(e => console.error("Error playing audio:", e));
                 } else {
                    audioElement.pause();
                 }
             });
        }
        if (audioElement) {
            audioElement.addEventListener('timeupdate', () => { if (!isSeeking && !isNaN(audioElement.duration) && seekBar && currentTimeDisplay) { seekBar.value = audioElement.currentTime; currentTimeDisplay.textContent = formatTime(audioElement.currentTime); } });
            audioElement.addEventListener('loadedmetadata', () => { if (!isNaN(audioElement.duration) && seekBar && durationDisplay) { seekBar.max = audioElement.duration; durationDisplay.textContent = formatTime(audioElement.duration); } });
            audioElement.addEventListener('play', updatePlayPauseIcon);
            audioElement.addEventListener('pause', updatePlayPauseIcon);
            audioElement.addEventListener('ended', updatePlayPauseIcon);
        }
        if (seekBar && currentTimeDisplay && audioElement) { // Check elements
            seekBar.addEventListener('input', () => { isSeeking = true; currentTimeDisplay.textContent = formatTime(parseFloat(seekBar.value) || 0); }); // Handle potential NaN
            seekBar.addEventListener('change', () => { if (!isNaN(audioElement.duration)) { audioElement.currentTime = parseFloat(seekBar.value) || 0; } isSeeking = false; });
        }


        // --- Audio Autoplay Workaround (with WeChat JSBridge Check) ---
        let hasInteracted = false;
        const isWeChat = /micromessenger/i.test(navigator.userAgent);

        function playAudio() {
            if (audioElement && audioElement.paused) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => { updatePlayPauseIcon(); });
                }
            } else {
                 updatePlayPauseIcon(); // Update icon even if already playing or no element
            }
        }
        function tryResumeAudio() {
            if (hasInteracted) {
                if (isWeChat) {
                    if (typeof WeixinJSBridge == "object" && typeof WeixinJSBridge.invoke == "function") { playAudio(); }
                    else { document.addEventListener("WeixinJSBridgeReady", playAudio, false); }
                } else { playAudio(); }
            } else { updatePlayPauseIcon(); } // Update icon if no interaction yet
        }
        function firstInteractionHandler() {
            if (!hasInteracted) {
                hasInteracted = true;
                tryResumeAudio();
                document.body.removeEventListener('click', firstInteractionHandler);
                document.body.removeEventListener('touchend', firstInteractionHandler);
            }
        }
        document.body.addEventListener('click', firstInteractionHandler, { once: false });
        document.body.addEventListener('touchend', firstInteractionHandler, { once: false, passive: true });


        // --- Slideshow Logic [Existing] ---
        function updateDots() { if (!dotsContainer || dotsContainer.children.length !== slideCount) return; for (let i = 0; i < slideCount; i++) { dotsContainer.children[i].classList.toggle('active', i === currentSlideIndex); } }
        function showSlide(index) { if (slideCount <= 0 || !slideshow) return; if (index >= slideCount) { currentSlideIndex = 0; } else if (index < 0) { currentSlideIndex = slideCount - 1; } else { currentSlideIndex = index; } const offset = -currentSlideIndex * 100; slideshow.style.transform = `translateX(${offset}%)`; updateDots(); }
        function nextSlide() { showSlide(currentSlideIndex + 1); }
        function startSlideshowAutoplay() { stopSlideshowAutoplay(); if (slideCount > 1) { slideInterval = setInterval(nextSlide, SLIDESHOW_INTERVAL_TIME); } }
        function stopSlideshowAutoplay() { clearInterval(slideInterval); slideInterval = null; }
        if (prevButton && nextButton) {
            prevButton.addEventListener('click', () => { stopSlideshowAutoplay(); showSlide(currentSlideIndex - 1); });
            nextButton.addEventListener('click', () => { stopSlideshowAutoplay(); showSlide(currentSlideIndex + 1); });
        }
        function createDots() { if (!dotsContainer || slideCount <= 0) return; dotsContainer.innerHTML = ''; for (let i = 0; i < slideCount; i++) { const dot = document.createElement('span'); dot.classList.add('dot'); dot.dataset.index = i; dot.setAttribute('aria-label', `跳转到照片 ${i + 1}`); dot.addEventListener('click', (e) => { stopSlideshowAutoplay(); const index = parseInt(e.target.dataset.index); showSlide(index); }); dotsContainer.appendChild(dot); } updateDots(); }

        // --- Draggable Audio Player Logic [Existing] ---
        let isDraggingPlayer = false; let playerOffsetX, playerOffsetY; let startX, startY;
        function dragStart(event) { isDraggingPlayer = true; audioPlayerContainer.style.transition = 'none'; if (event.type === 'touchstart') { startX = event.touches[0].clientX; startY = event.touches[0].clientY; } else { startX = event.clientX; startY = event.clientY; event.preventDefault(); } const rect = audioPlayerContainer.getBoundingClientRect(); playerOffsetX = startX - rect.left; playerOffsetY = startY - rect.top; document.addEventListener('mousemove', dragging); document.addEventListener('touchmove', dragging, { passive: false }); document.addEventListener('mouseup', dragEnd); document.addEventListener('touchend', dragEnd); }
        function dragging(event) { if (!isDraggingPlayer) return; let currentX, currentY; if (event.type === 'touchmove') { event.preventDefault(); currentX = event.touches[0].clientX; currentY = event.touches[0].clientY; } else { currentX = event.clientX; currentY = event.clientY; } let newLeft = currentX - playerOffsetX; let newTop = currentY - playerOffsetY; const containerWidth = audioPlayerContainer.offsetWidth; const containerHeight = audioPlayerContainer.offsetHeight; const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight; if (newLeft < 0) newLeft = 0; if (newTop < 0) newTop = 0; if (newLeft + containerWidth > viewportWidth) newLeft = viewportWidth - containerWidth; if (newTop + containerHeight > viewportHeight) newTop = viewportHeight - containerHeight; audioPlayerContainer.style.left = `${newLeft}px`; audioPlayerContainer.style.top = `${newTop}px`; audioPlayerContainer.style.right = 'auto'; audioPlayerContainer.style.bottom = 'auto'; audioPlayerContainer.style.transform = 'none'; }
        function dragEnd() { if (isDraggingPlayer) { isDraggingPlayer = false; audioPlayerContainer.style.transition = ''; document.removeEventListener('mousemove', dragging); document.removeEventListener('touchmove', dragging); document.removeEventListener('mouseup', dragEnd); document.removeEventListener('touchend', dragEnd); } }
        if (audioPlayerContainer) {
             audioPlayerContainer.addEventListener('mousedown', dragStart);
             audioPlayerContainer.addEventListener('touchstart', dragStart, { passive: false });
        }


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Defer initialization requiring DOM elements until DOM is ready
            if (birthdayView) birthdayView.style.position = 'relative';
            if (loveLetterView) loveLetterView.style.position = 'relative';
            if (birthdayView) {
                birthdayIntervalId = startFallingItems(birthdayIntervalId, birthdayItems, birthdayView, BIRTHDAY_INTERVAL_TIME);
            }
            if (audioElement) {
                updatePlayPauseIcon();
                // Initial play attempt deferred slightly or handled by interaction
                // Consider removing initial play attempt completely for WeChat stability
                 // audioElement.play().catch(e => { updatePlayPauseIcon(); });
            } else {
                 // If no audio element, hide player?
                 if (audioPlayerContainer) audioPlayerContainer.style.display = 'none';
            }
            if (slideshow && slideCount > 0) {
                createDots();
                showSlide(0);
                startSlideshowAutoplay();
            } else {
                const slideshowContainer = document.getElementById('photo-slideshow-container');
                if(slideshowContainer) slideshowContainer.style.display = 'none';
            }
        });


    </script>

</body>
</html>